var t=Object.defineProperty,e=Object.defineProperties,i=Object.getOwnPropertyDescriptors,s=Object.getOwnPropertySymbols,a=Object.prototype.hasOwnProperty,o=Object.prototype.propertyIsEnumerable,n=(e,i,s)=>i in e?t(e,i,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[i]=s,r=(t,e)=>{for(var i in e||(e={}))a.call(e,i)&&n(t,i,e[i]);if(s)for(var i of s(e))o.call(e,i)&&n(t,i,e[i]);return t},c=(t,s)=>e(t,i(s));import{o as h,c as d,w as l,a as u,b as f,v as m,r as p,F as g,P as A,d as w,e as v,t as k,f as b,g as y,h as x,i as C,j as B,T as P,J as D,k as S,l as I,m as T,n as N}from"./vendor.0037c1b4.js";const j=class{init(t){this.defaultOnmessage=t,this.buffer={}}connect(){this.socket=new WebSocket(`${"https:"===location.protocol?"wss":"ws"}://${location.host}/websocket`),this.connected=!0}setDefault(){this.onmessage=t=>this.defaultOnmessage(t)}generatePacketId(t){const e=[];for(let s=0;s<26;s++)e.push(String.fromCharCode("a".charCodeAt(0)+s));for(let s=0;s<26;s++)e.push(String.fromCharCode("A".charCodeAt(0)+s));for(let s=0;s<10;s++)e.push(String(s));let i="";for(let s=0;s<t;s++)i+=e[Math.floor(Math.random()*e.length)];return this.buffer.hasOwnProperty(i)?this.generatePacketId():i}send(t){const e=JSON.stringify(t);if(e.length>j.MAX_DATA_SIZE){this.lastSendDataBlobURL&&URL.revokeObjectURL(this.lastSendDataBlobURL),this.lastSendDataBlobURL=URL.createObjectURL(new Blob([e],{type:"application/json"}));const i=this.generatePacketId(8),s=Math.ceil(e.length/j.MAX_DATA_SIZE);for(let a=0;a<s;a++){const o=a*j.MAX_DATA_SIZE;let n=o+j.MAX_DATA_SIZE;n>e.length&&(n=e.length),this.socket.send(JSON.stringify({type:"packet",target:t.target,packetId:i,numOfPackets:s,index:a,body:e.slice(o,n)}))}}else this.socket.send(e)}close(){var t;null==(t=this.socket)||t.close()}set onopen(t){this.socket.onopen=e=>{this.socket.send(JSON.stringify({type:"ping"})),console.info("接続しました。"),t(e)}}set onmessage(t){this.socket.onmessage=e=>{const i=JSON.parse(e.data);if("pong"!==i.type)switch(console.log(i),i.type){case"packet":if(!this.buffer.hasOwnProperty(i.packetId)){this.buffer[i.packetId]=[];for(let t=0;t<i.numOfPackets;t++)this.buffer[i.packetId].push(void 0)}if(this.buffer[i.packetId][i.index]=i,this.buffer[i.packetId].every((t=>t))){const e=JSON.parse(this.buffer[i.packetId].reduce(((t,e)=>t+e.body),""));t(e),delete this.buffer[i.packetId]}break;case"packet_id_overlapped_error":const e=new FileReader;e.onload((()=>this.send(JSON.parse(e.result)))),e.readAsText(this.lastSendDataBlobURL);break;case"msg":console.info(i.msg);break;default:t(i)}else this.socket.send(JSON.stringify({type:"ping"}))}}set onclose(t){this.socket.onclose=e=>{t(e),console.info("接続が閉じられました。")}}set onerror(t){this.socket.onerror=e=>{t(e),console.error(e)}}};let $=j;var E;n($,"symbol"!=typeof(E="MAX_DATA_SIZE")?E+"":E,1e7);const O={name:"SideMenu",data:()=>({isShow:!1}),mounted(){document.onclick=t=>this.isShow=!1}};O.render=function(t,e,i,s,a,o){return h(),d(g,null,[(h(),d("svg",{id:"menu-btn",onClick:e[1]||(e[1]=l((t=>a.isShow=!a.isShow),["stop"]))},[u("use",{href:"/assets/hamburger.dab2f6d8.svg#hamburger",fill:a.isShow?"#323232":"white",stroke:a.isShow?"#323232":"white"},null,8,["fill","stroke"])])),f(u("div",{id:"side-menu",onClick:e[2]||(e[2]=l((()=>{}),["stop"])),onKeydown:e[3]||(e[3]=l((()=>{}),["stop"]))},[p(t.$slots,"default")],544),[[m,a.isShow]])],64)};const R={name:"VideoContainer",props:["stream","roomId"],data:()=>({videoOn:!0,audioOn:!0,videoParams:[],videos:[],room:null}),async mounted(){console.log("VideoContainer",this.stream),this.$refs.localVideo.srcObject=this.stream;const t=new A({key:"8ce51882-3317-4964-99cc-a7e50809042a",debug:3});t.on("open",(()=>{const e=t.joinRoom(this.roomId,{mode:"sfu",stream:this.stream});this.room=e,e.once("open",(()=>console.log("=== You joined ==="))),e.on("peerJoin",(t=>console.log(`=== ${t} joined ===`))),e.on("stream",(async t=>{this.videoParams.push({peerId:t.peerId}),this.$nextTick((function(){this.videos[this.videos.length-1].srcObject=t,this.videos[this.videos.length-1].peerId=t.peerId}))})),e.on("data",(({data:t,src:e})=>console.log(`${e}: ${t}`))),e.on("peerLeave",(t=>{const e=this.videos.find((e=>e.peerId===t));e.srcObject.getTracks().forEach((t=>t.stop())),e.srcObject=null;const i=this.videoParams.indexOf((e=>e.peerId===t));this.videoParams.splice(i,1),console.log(`=== ${t} left ===`)})),e.once("close",(()=>{console.log("== You left ==="),this.videos.forEach((t=>{t.srcObject.getTracks().forEach((t=>t.stop())),t.srcObject=null})),this.$refs.localVideo.srcObject=null,this.videoParams=[]}))})),t.on("error",console.error)},watch:{videoOn(t){const e=this.stream.getVideoTracks();e.length&&(e[0].enabled=t)},audioOn(t){this.stream.getAudioTracks()[0].enabled=t,console.log(this.stream.getAudioTracks()[0].enabled)}},methods:{setVideoRef(t){t&&!this.videos.includes(t)&&this.videos.push(t)}}},F={id:"video-container"},M={id:"local-video",muted:"",playsinline:"",ref:"localVideo"};R.render=function(t,e,i,s,a,o){return h(),d("div",F,[u("video",M,null,512),u("button",{type:"button",class:["video-btn",{active:a.videoOn}],onClick:e[1]||(e[1]=t=>a.videoOn=!a.videoOn),ref:"videoBtn"},"video",2),u("button",{type:"button",class:["video-btn",{active:a.audioOn}],onClick:e[2]||(e[2]=t=>a.audioOn=!a.audioOn),ref:"audioBtn"},"audio",2),(h(!0),d(g,null,w(a.videoParams,(t=>(h(),d("video",{class:"member-video",playsinline:"",key:t.peerId,ref:o.setVideoRef},null,512)))),128))])};const U={name:"Popup",emits:["hide-popup"]};U.render=function(t,e,i,s,a,o){return h(),d("div",{id:"popup-background",onClick:e[2]||(e[2]=l((e=>t.$emit("hide-popup")),["stop"])),onKeydown:e[3]||(e[3]=l((()=>{}),["stop"]))},[u("div",{id:"popup",onClick:e[1]||(e[1]=l((()=>{}),["stop"]))},[p(t.$slots,"default")])],32)};const Q={name:"WriteRange",emits:["hide-popup","write-project"],data:()=>({startBar:"",startBeat:"",stopBar:"",stopBeat:""}),computed:{minBar:()=>0,maxBar(){return this.$store.state.number_of_bars},minBeat:()=>1,maxBeat(){return this.$store.state.rhythm[0]},maxStartBar(){return this.maxBar-1},minStopBar(){return this.startBeat==this.maxBeat?Number(this.startBar)+1:this.startBar},minStopBeat(){return this.startBar===this.stopBar?Number(this.startBeat)+1:1},maxStopBeat(){return this.startBar==this.maxStartBar?1:this.maxBeat}},methods:{writeProject(t){t.preventDefault();const e=Object.freeze({bar:Number(this.startBar),beat:Number(this.startBeat)}),i=Object.freeze({bar:Number(this.stopBar),beat:Number(this.stopBeat)});this.$emit("write-project",{start:e,stop:i}),this.$emit("hide-popup")},reset(){this.startBar="",this.startBeat="",this.stopBar="",this.stopBeat=""},hide(){this.reset(),this.$emit("hide-popup")}}},_={id:"write-range-container"},L=u("tr",null,[u("th"),u("th",null,"小節"),u("th",null,"拍")],-1),z=u("th",null,"start",-1),V=u("th",null,"stop",-1),H=u("button",{type:"submit"},"決定",-1);Q.render=function(t,e,i,s,a,o){return h(),d("div",_,[u("form",{onSubmit:e[6]||(e[6]=(...t)=>o.writeProject&&o.writeProject(...t))},[u("table",null,[L,u("tr",null,[z,u("td",null,[f(u("input",{type:"number",required:"",min:o.minBar,max:o.maxStartBar,"onUpdate:modelValue":e[1]||(e[1]=t=>a.startBar=t)},null,8,["min","max"]),[[v,a.startBar]])]),u("td",null,[f(u("input",{type:"number",required:"",min:o.minBeat,max:o.maxBeat,"onUpdate:modelValue":e[2]||(e[2]=t=>a.startBeat=t)},null,8,["min","max"]),[[v,a.startBeat]])])]),u("tr",null,[V,u("td",null,[f(u("input",{type:"number",required:"",min:o.minStopBar,max:o.maxBar,"onUpdate:modelValue":e[3]||(e[3]=t=>a.stopBar=t)},null,8,["min","max"]),[[v,a.stopBar]])]),u("td",null,[f(u("input",{type:"number",required:"",min:o.minStopBeat,max:o.maxStopBeat,"onUpdate:modelValue":e[4]||(e[4]=t=>a.stopBeat=t)},null,8,["min","max"]),[[v,a.stopBeat]])])])]),u("p",null,[H,u("button",{type:"button",onClick:e[5]||(e[5]=(...t)=>o.hide&&o.hide(...t))},"中止")])],32)])};class X{static Base642Wav(t){const e=t.split(","),i=e[0].slice(5,-7),s=atob(e[1]),a=new Uint8Array(s.length);for(let n=0;n<s.length;n++)a[n]=s.charCodeAt(n);const o=new Blob([a],{type:i[1]});return URL.createObjectURL(o)}static AudioBuffer2WavFile(t){return X.writeWav(X.AudioBuffer2WavData(t),t.sampleRate)}static AudioBuffer2WavData(t){const e=t.getChannelData(0),i=t.getChannelData(1),s=new Float32Array(2*t.length);for(let a=0;a<t.length;a++)s[2*a]=e[a],s[2*a+1]=i[a];return s}static writeWav(t,e){const i=new ArrayBuffer(44+2*t.length),s=new DataView(i);X.writeWavHead(s,t.length,e),X.writeWavData(s,t);const a=new Blob([s],{type:"audio/wav"});return URL.createObjectURL(a)}static writeWavHead(t,e,i){const s=function(t,e,i){for(let s=0;s<i.length;s++)t.setUint8(e+s,i.charCodeAt(s))};s(t,0,"RIFF"),t.setUint32(4,32+2*e,!0),s(t,8,"WAVE"),s(t,12,"fmt "),t.setUint32(16,16,!0),t.setUint16(20,1,!0),t.setUint16(22,2,!0),t.setUint32(24,i,!0),t.setUint32(28,2*i,!0),t.setUint16(32,2,!0),t.setUint16(34,16,!0),s(t,36,"data"),t.setUint32(40,2*e,!0)}static writeWavData(t,e){for(let i=0,s=44;i<e.length;i++,s+=2){let a=Math.max(-1,Math.min(1,e[i]));t.setInt16(s,a<0?32768*a:32767*a,!0)}}}class Y{constructor(t,e,i){this.audioCtx=t,this.url=e,this.data=i}async load(){return await fetch(this.url).then((t=>t.arrayBuffer())).then((t=>this.audioCtx.decodeAudioData(t))).then((t=>this.data.buffer=t)).catch(console.error)}}class G{constructor(t,e){this.audioCtx=t,this.sourceNode=e,this.recorderNode=this.audioCtx.createScriptProcessor(0,1),this.recorderNode.onaudioprocess=t=>{const e=t.inputBuffer.getChannelData(0),i=new Float32Array(2*t.inputBuffer.length);for(let s=0;s<t.inputBuffer.length;s++)i[2*s]=i[2*s+1]=e[s];this.audioData.push(i)},this.audioData=[]}start(){this.sourceNode.connect(this.recorderNode).connect(this.audioCtx.destination),this.onstart()}stop(){this.sourceNode.disconnect(this.recorderNode),this.recorderNode.disconnect(),this.onstop(X.writeWav(this.mergeBuffers(this.audioData),this.audioCtx.sampleRate)),this.audioData=[]}mergeBuffers(t){let e=0;for(let a=0;a<t.length;a++)e+=t[a].length;let i=new Float32Array(e),s=0;for(let a=0;a<t.length;a++)for(let e=0;e<t[a].length;e++)i[s]=t[a][e],s++;return i}}const W={name:"Count",props:["audioCtx"],data:()=>({isMuted:!1,number:1}),async mounted(){this.bufferContainer={buffer:null},this.loader=new Y(this.audioCtx,"/metronome.wav",this.bufferContainer),await this.loader.load()},computed:{rhythm(){return this.$store.state.rhythm},count_time(){return 60/this.$store.state.bpm*4/this.rhythm[1]}},methods:{start(t=0){setTimeout((()=>{0!==t?this.count():this.playMetronome(),this.countId=setInterval((()=>{this.count()}),1e3*this.count_time)}),1e3*t)},stop(){clearInterval(this.countId),this.pauseMetronome()},count(){this.number==this.rhythm[0]?this.number=1:this.number++,this.playMetronome()},playMetronome(){this.isMuted||(this.source=this.audioCtx.createBufferSource(),this.source.buffer=this.bufferContainer.buffer,this.source.connect(this.audioCtx.destination),this.source.start())},pauseMetronome(){this.source&&(this.source.stop(),this.source.disconnect())},setNumberFromPointerX(t){const e=this.$store.getters;this.number=Math.floor(t%e.bar_width/e.scale_interval)+1,this.number<=0&&(this.number+=this.rhythm[0])}}},J={id:"count"};W.render=function(t,e,i,s,a,o){return h(),d(g,null,[(h(),d("svg",{id:"metronome",onClick:e[1]||(e[1]=t=>{a.isMuted=!a.isMuted})},[u("use",{href:"/assets/metronome.cb73d681.svg#metronome",fill:a.isMuted?"red":"white",stroke:a.isMuted?"red":"white"},null,8,["fill","stroke"])])),u("div",J,k(a.number),1)],64)};const K={name:"InputElement",props:["type","size","default"],data(){return{isInputing:!1,value:this.default,disabled:!1}},methods:{finishInput(){this.value=this.value.trim().replace(/\r?\n/g,""),this.value&&(this.isInputing=!1,this.$emit("value-changed",this.value))}}},q={class:"input-element"};K.render=function(t,e,i,s,a,o){return h(),d("div",q,[a.isInputing?f((h(),d("input",{key:1,type:i.type,style:{width:i.size+"rem"},"onUpdate:modelValue":e[2]||(e[2]=t=>a.value=t),onKeydown:[e[3]||(e[3]=y(l(((...t)=>o.finishInput&&o.finishInput(...t)),["stop"]),["enter"])),e[4]||(e[4]=l((()=>{}),["stop"]))]},null,44,["type"])),[[b,a.value]]):(h(),d("p",{key:0,onDblclick:e[1]||(e[1]=t=>{a.disabled||(a.isInputing=!0)})},k(a.value),33))])};const Z={name:"Rhythm",components:{InputElement:K},methods:{init(t){this.$refs.inputElement.value=t.join("/"),this.$store.commit("rhythm",t.map((t=>Number(t))))},valueChanged(t){this.$store.commit("rhythm",t.split("/").map((t=>Number(t))))}}};Z.render=function(t,e,i,s,a,o){const n=x("InputElement");return h(),d(n,{type:"text",size:"3",default:"4/4",onValueChanged:o.valueChanged,ref:"inputElement"},null,8,["onValueChanged"])};const tt={name:"Bpm",components:{InputElement:K},computed:{disabled:{get:function(){return this.$refs.inputElement.disabled},set:function(t){this.$refs.inputElement.disabled=t}}},methods:{init(t){this.$refs.inputElement.value=t,this.$store.commit("bpm",Number(t))},valueChanged(t){this.disabled?this.$refs.inputElement.value=this.$store.state.bpm:this.$store.commit("bpm",Number(t))}}};tt.render=function(t,e,i,s,a,o){const n=x("InputElement");return h(),d(n,{type:"number",size:"3",default:"120",onValueChanged:o.valueChanged,ref:"inputElement"},null,8,["onValueChanged"])};const et={name:"Resizer",data:()=>({value:20,disabled:!1}),methods:{init(t){this.value=t,this.$store.commit("beat_interval",Number(t))},valueChanged(){this.$store.commit("beat_interval",Number(this.value))}}};et.render=function(t,e,i,s,a,o){return f((h(),d("input",{type:"range",min:"10",max:"100",step:"1",title:a.value,"onUpdate:modelValue":e[1]||(e[1]=t=>a.value=t),onInput:e[2]||(e[2]=(...t)=>o.valueChanged&&o.valueChanged(...t)),disabled:a.disabled},null,40,["title","disabled"])),[[v,a.value]])};const it={name:"AddTrackBtn",emits:["add-track"]},st=u("img",{src:"/assets/plus_icon.d7fa19c0.png"},null,-1);it.render=function(t,e,i,s,a,o){return h(),d("div",{id:"add_track_btn",title:"トラックを追加",onClick:e[1]||(e[1]=e=>t.$emit("add-track"))},[st])};const at={name:"Ruler",mounted(){this.ctx=this.canvas.getContext("2d"),this.ctx.font="10px",this.draw()},computed:{rhythm(){return this.$store.state.rhythm},beat_interval(){return this.$store.state.beat_interval},number_of_bars(){return this.$store.state.number_of_bars},canvas(){return this.$refs.canvas}},watch:{rhythm(){this.draw()},beat_interval(){this.draw()},number_of_bars(){this.draw()}},methods:{draw(){this.canvas.width=this.$store.getters.ruler_width,this.ctx.fillStyle="#323232",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.ctx.strokeStyle=this.ctx.fillStyle="#f0f0f0";const t=this.rhythm[0],e=this.$store.getters.scale_interval;for(let i=0;i<this.canvas.width/e;i++){const s=i*e;this.ctx.beginPath(),i%t==0?(this.ctx.fillText(`${Math.floor(i/t)}`,s,12),this.ctx.moveTo(s,15)):this.ctx.moveTo(s,25),this.ctx.lineTo(s,30),this.ctx.stroke()}}}},ot={id:"ruler",height:"30",ref:"canvas"};at.render=function(t,e,i,s,a,o){return h(),d("canvas",ot,null,512)};const nt={name:"Pointer",props:{margin:Number},data(){return{styles:{left:this.margin+"px"}}},mounted(){this.canvas.height=window.innerHeight-80,this.ctx=this.canvas.getContext("2d"),this.ctx.fillStyle="#f0f0f0",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height)},computed:{beat_interval(){return this.$store.state.beat_interval},canvas(){return this.$refs.canvas},layerX:{get:function(){return this.styles.left.slice(0,-2)-0},set:function(t){this.styles.left=t+"px"}},x:{get:function(){return this.layerX-this.margin},set:function(t){this.layerX=t+this.margin}}},watch:{beat_interval(t,e){this.x*=t/e}},methods:{start(){let t=()=>{this.move(),this.animationId=requestAnimationFrame(t)};this.animationId=requestAnimationFrame(t)},stop(){cancelAnimationFrame(this.animationId)},prepareRecording(){const t=this.$store.state.rhythm,e=this.$store.getters.scale_interval;this.x>=0?this.x=(Math.floor(this.x/e)-t[0])*e:this.x=-t[0]*e},move(){this.$emit("move",{layerX:this.layerX,x:this.x}),this.x+=this.$store.getters.animation_width}}};nt.render=function(t,e,i,s,a,o){return h(),d("canvas",{id:"pointer",style:a.styles,width:"2",ref:"canvas"},null,4)};const rt={name:"ContextMenu",data:()=>({styles:{top:"0px",left:"0px"},isShow:!1}),methods:{show(t){switch(t.type){case"contextmenu":t.preventDefault(),this.styles.top=t.clientY+"px",this.styles.left=t.clientX+"px";break;case"touchstart":if(2!==t.touches.length)return;this.styles.top=(t.touches[0].clientY+t.touches[1].clientY)/2+"px",this.styles.left=(t.touches[0].clientX+t.touches[1].clientX)/2+"px"}this.isShow=!0,setTimeout((()=>this.$refs.domElement.focus()))}}};rt.render=function(t,e,i,s,a,o){return f((h(),d("div",{class:"context-menu",tabindex:"-1",style:a.styles,onBlur:e[1]||(e[1]=t=>{a.isShow=!1}),ref:"domElement"},[u("ul",null,[p(t.$slots,"default")])],36)),[[m,a.isShow]])};const ct={name:"TrackLabel",props:["gainNode","pannerNode","muteNode"],emits:["track-selected","track-solo","track-remove"],components:{InputElement:K,ContextMenu:rt},data:()=>({isSelected:!1,selectedSlider:"V",gainValue:.5,panValue:0,isMonitoring:!1,isMuted:!1,isSolo:!1}),watch:{gainValue(t){this.gainNode.gain.value=t},panValue(t){this.pannerNode.pan.value=t},isMuted(t){this.muteNode.gain.value=t?0:1},isSolo(t){this.$emit("track-solo")}}},ht={class:"track-label-inner-container"},dt={class:"track-slider-container"},lt=u("option",{selected:"",title:"音量"},"V",-1),ut=u("option",{title:"パン"},"P",-1),ft={class:"track-btn-container"},mt=u("use",{href:"/assets/monitor_off.a262b164.svg#monitor_off",fill:"#323232"},null,-1),pt=u("use",{href:"/assets/monitor_on.8ded233d.svg#monitor_on",fill:"red"},null,-1),gt=u("use",{href:"/assets/volume_on.c661966d.svg#volume_on",fill:"#323232",stroke:"#323232"},null,-1),At=u("use",{href:"/assets/volume_off.f004657e.svg#volume_off",fill:"#323232",stroke:"#323232"},null,-1);ct.render=function(t,e,i,s,a,o){const n=x("InputElement"),r=x("ContextMenu");return h(),d(g,null,[u("div",{class:["track-label",{"is-selected":a.isSelected}],onPointerdown:e[7]||(e[7]=e=>t.$emit("track-selected",e.shiftKey)),onContextmenu:e[8]||(e[8]=(...e)=>t.$refs.menu.show&&t.$refs.menu.show(...e)),onTouchstart:e[9]||(e[9]=(...e)=>t.$refs.menu.show&&t.$refs.menu.show(...e))},[u("div",ht,[u(n,{type:"text",size:"8",default:"新規トラック",ref:"trackName"},null,512),u("div",dt,[f(u("select",{"onUpdate:modelValue":e[1]||(e[1]=t=>a.selectedSlider=t)},[lt,ut],512),[[C,a.selectedSlider]]),f(u("input",{type:"range",min:"0",max:"1",step:"0.05","onUpdate:modelValue":e[2]||(e[2]=t=>a.gainValue=t),title:"音量:"+a.gainValue},null,8,["title"]),[[m,"V"===a.selectedSlider],[v,a.gainValue]]),f(u("input",{type:"range",min:"-1",max:"1",step:"0.1","onUpdate:modelValue":e[3]||(e[3]=t=>a.panValue=t),title:"パン:"+a.panValue},null,8,["title"]),[[m,"P"===a.selectedSlider],[v,a.panValue]])]),u("div",ft,[u("button",{type:"button",class:"track-btn track-monitor-btn",onClick:e[4]||(e[4]=t=>a.isMonitoring=!a.isMonitoring),title:"入力モニタリング"},[f((h(),d("svg",null,[mt],512)),[[m,!a.isMonitoring]]),f((h(),d("svg",null,[pt],512)),[[m,a.isMonitoring]])]),u("button",{type:"button",class:"track-btn track-mute-btn",onClick:e[5]||(e[5]=t=>a.isMuted=!a.isMuted),title:"消音"},[f((h(),d("svg",null,[gt],512)),[[m,!a.isMuted]]),f((h(),d("svg",null,[At],512)),[[m,a.isMuted]])]),u("button",{type:"button",class:["track-btn track-solo-btn",{active:a.isSolo}],onClick:e[6]||(e[6]=t=>a.isSolo=!a.isSolo),title:"ソロ再生"},"Solo",2)])])],34),u(r,{ref:"menu"},{default:B((()=>[u("li",{onClick:e[10]||(e[10]=l((e=>t.$emit("track-remove")),["stop"]))},"削除")])),_:1},512)],64)};const wt={name:"DraftCanvas",props:["audioCtx","sourceNode"],data:()=>({styles:{left:"0px"},isShow:!1}),created(){this.analyserNode=this.audioCtx.createAnalyser(),this.analyserNode.fftSize=1024,this.sourceNode.connect(this.analyserNode),this.dataArray=new Uint8Array(this.analyserNode.fftSize),this.drawPoint=0},unmounted(){this.sourceNode.disconnect(this.analyserNode)},mounted(){this.ctx=this.canvas.getContext("2d"),this.initCtxStyle()},computed:{canvas(){return this.$refs.canvas},slice_width(){return this.$store.getters.animation_width/this.dataArray.length}},methods:{initCtxStyle(){this.ctx.fillStyle="#78328c",this.ctx.lineWidth=2,this.ctx.strokeStyle="#000"},show(t){this.styles.left=t+"px",this.canvas.width=1e3,this.initCtxStyle(),this.drawPoint=0,this.isShow=!0},hide(){this.isShow=!1},draw(){this.drawPoint>=this.canvas.width&&this.resize(),this.analyserNode.getByteTimeDomainData(this.dataArray),this.ctx.fillRect(this.drawPoint,0,this.$store.getters.animation_width,this.canvas.height),this.ctx.beginPath();for(let t=0;t<this.dataArray.length;t++){let e=this.dataArray[t]/256*this.canvas.height;0===t?this.ctx.moveTo(this.drawPoint,e):this.ctx.lineTo(this.drawPoint,e),this.drawPoint+=this.slice_width}this.ctx.stroke()},resize(){const t=document.createElement("canvas"),e=t.getContext("2d");t.width=this.canvas.width,t.height=this.canvas.height,e.drawImage(this.canvas,0,0,this.canvas.width,this.canvas.height),this.canvas.width+=1e3,this.initCtxStyle(),this.ctx.drawImage(t,0,0,t.width,t.height)}}};wt.render=function(t,e,i,s,a,o){return f((h(),d("canvas",{class:"draft-canvas",style:a.styles,width:"1000",height:"120",ref:"canvas"},null,4)),[[m,a.isShow]])};class vt{constructor(t,e,i){this.audioCtx=t,this.nextNode=e,this.data=i}createSource(){this.source=this.audioCtx.createBufferSource(),this.source.buffer=this.data.buffer,this.source.connect(this.nextNode)}play(t,e,i){this.createSource(),this.source.onended=i,this.source.start(0,t,e-t)}pause(){this.source&&(this.source.stop(),this.source.disconnect())}}class kt{constructor(t){this.audioCtx=t}getDrawData(t,e,i,s){const a=[];for(let o=0;o<t.numberOfChannels;o++)a[o]=this.getPeaks(this.getDrawRange(t.getChannelData(o),e,i),s);return a}getDrawRange(t,e,i){const s=this.audioCtx.sampleRate*e,a=this.audioCtx.sampleRate*i;return t.slice(Math.floor(s),Math.floor(a))}getPeaks(t,e){e||(e=4500);let i=Math.floor(t.length/e);i<1&&(i=1);const s=[];for(let a=0;a<t.length;a+=i){const e=this.getPeak(t,a,a+i);s.push(e.max,e.min)}return s}getPeak(t,e,i){const s=t.slice(e,i);let a=s[0],o=a;for(let n=0;n<s.length;n++){const t=s[n];t>a&&(a=t),t<o&&(o=t)}return Object.freeze({max:a,min:o})}}class bt{constructor(t,e,i){this.canvas=t,this.ctx=e,this.data=i,this.initCtxStyle()}initCtxStyle(){this.ctx.fillStyle="#78328c",this.ctx.lineWidth=2,this.ctx.strokeStyle="#000"}draw(t){this.initCtxStyle(),this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),t.forEach((t=>this.drawData(t)))}drawData(t){const e=this.canvas.width/t.length;let i=0;this.ctx.beginPath();for(let s=0;s<t.length;s++){let a=(t[s]+1)/2*this.canvas.height;0===s?this.ctx.moveTo(i,a):this.ctx.lineTo(i,a),i+=e}this.ctx.stroke()}}const yt={name:"AudioCanvas",components:{ContextMenu:rt},props:["initConfig","audioCtx","nextNode"],emits:["track-selected","remove"],data:()=>({styles:{left:"0px"},_width:0,isSelected:!1}),async mounted(){this.ctx=this.canvas.getContext("2d"),this.x=this.initConfig.startPoint,this.initDiminished(this.initConfig.diminished),this.canvas.onpointerover=t=>{this.decideCursor(t.offsetX),this.canvas.onpointermove=t=>this.decideCursor(t.offsetX)},this.canvas.ontouchmove=t=>{t.preventDefault(),t.stopPropagation()},this.canvas.onpointerdown=t=>{t.stopPropagation(),this.canvas.focus(),this.$emit("track-selected",t.shiftKey);const e=t.offsetX;if(e<=30)this.canvas.onpointermove=t=>{this.decideCursor(t.offsetX),this.resizeLeft(e,t.offsetX)};else if(this.width-e<=30){let t=e;this.canvas.onpointermove=e=>{this.decideCursor(e.offsetX),this.resizeRight(t,e.offsetX),t=e.offsetX}}else this.styles.cursor="grabbing",this.canvas.onpointermove=t=>this.move(e,t.offsetX)},this.canvas.ontouchend=t=>{t.preventDefault(),t.stopPropagation()},this.canvas.onpointerup=t=>{t.preventDefault(),t.stopPropagation(),this.decideCursor(t.offsetX),this.canvas.onpointermove=t=>this.decideCursor(t.offsetX)},this.canvas.onpointerout=t=>{t.preventDefault(),t.stopPropagation(),delete this.styles.cursor,this.canvas.onpointermove=null},this.canvas.onclick=t=>{t.preventDefault(),t.stopPropagation()},this.data={buffer:null},this.loader=new Y(this.audioCtx,this.initConfig.url,this.data),this.player=new vt(this.audioCtx,this.nextNode,this.data),this.drawer=new bt(this.canvas,this.ctx,this.data),this.drawdataprocessor=new kt(this.audioCtx),await this.loader.load(),this.width=this.data.buffer.duration*this.$store.getters.second_width,this.width>this.$store.getters.ruler_width&&this.$store.commit("number_of_bars",this.$store.getters.getNumberOfBarsFromDuration(this.data.buffer.duration))},computed:{bpm(){return this.$store.state.bpm},beat_interval(){return this.$store.state.beat_interval},second_width(){return this.bpm/60*this.beat_interval},canvas(){return this.$refs.canvas},x:{get:function(){return this.styles.left.slice(0,-2)-0},set:function(t){t<0&&(t=0),this.styles.left=t+"px"}},width:{get:function(){return this._width},set:function(t){this._width=Math.round(t)}},initStartPoint(){return this.x-this.diminished.left},initEndPoint(){return this.x+this.width+this.diminished.right},startPoint(){return this.x},endPoint(){return this.x+this.width},initStartTime(){return this.$store.getters.getTimeOfDistance(this.initStartPoint)},initEndTime(){return this.$store.getters.getTimeOfDistance(this.initEndPoint)},startTime(){return this.$store.getters.getTimeOfDistance(this.startPoint)},endTime(){return this.$store.getters.getTimeOfDistance(this.endPoint)},initDuration(){return this.$store.getters.getTimeOfDistance(this.diminished.left+this.width+this.diminished.right)},duration(){return this.$store.getters.getTimeOfDistance(this.width)}},watch:{bpm(t,e){this.width*=t/e},beat_interval(t,e){this.zoom(t,e)},width(){this.$nextTick((function(){this.draw()}))}},methods:{decideCursor(t){t<=30?this.styles.cursor=0===this.diminished.left?"e-resize":"ew-resize":this.width-t<=30?this.styles.cursor=0===this.diminished.right?"w-resize":"ew-resize":this.styles.cursor="grab"},initDiminished(t={left:0,right:0}){this.diminished=c(r({},t),{getData(){return{left:this.left,right:this.right}}}),Object.defineProperties(this.diminished,{leftTime:{get:()=>this.$store.getters.getTimeOfDistance(this.diminished.left)},rightTime:{get:()=>this.$store.getters.getTimeOfDistance(this.diminished.right)}})},getTime(t){return this.$store.getters.getTimeOfDistance(t-this.initStartPoint)},play(t,e){this.player.play(this.getTime(t),this.getTime(this.endPoint),e)},pause(){this.player.pause()},draw(){this.drawer.draw(this.drawdataprocessor.getDrawData(this.data.buffer,this.getTime(this.startPoint),this.getTime(this.endPoint)))},async zoom(t,e){this.data.buffer||await this.loader.load();const i=t/e;this.diminished.left*=i,this.diminished.right*=i,this.x*=i,this.width*=i},move(t,e){this.x+=e-t},resizeLeft(t,e){e<t?this.lengthenLeft(t,e):this.shortenLeft(t,e)},lengthenLeft(t,e){let i=Math.floor(t-e);this.diminished.left<i&&(i=this.diminished.left),this.x-=i,this.width+=i,this.diminished.left-=i},shortenLeft(t,e){let i=Math.floor(e-t);this.width-i<60&&(i=this.width-60),this.x+=i,this.width-=i,this.diminished.left+=i},resizeRight(t,e){t<e?this.lengthenRight(t,e):this.shortenRight(t,e)},lengthenRight(t,e){let i=Math.floor(e-t);this.diminished.right<i&&(i=this.diminished.right),this.width+=i,this.diminished.right-=i},shortenRight(t,e){let i=Math.floor(t-e);this.width-i<60&&(i=this.width-60),this.width-=i,this.diminished.right+=i},downloadAudioFile(){const t=this.duration*this.audioCtx.sampleRate,e=new(window.OfflineAudioContext||window.webkitOfflineAudioContext)(2,t,this.audioCtx.sampleRate),i=e.createBufferSource();i.buffer=this.data.buffer,i.connect(e.destination),i.start(0,this.diminished.leftTime,this.duration),e.startRendering().then((t=>{const e=X.AudioBuffer2WavFile(t),i=document.createElement("a");i.href=e,i.download="audio.wav",i.click()})).catch(console.error)},async getDownloadData(t,e){return await fetch(this.loader.url).then((t=>t.blob())).then((i=>t.file(e+".wav",i))).catch(console.error),{startPoint:this.startPoint,diminished:this.diminished.getData()}},async getUploadData(){const t=await fetch(this.loader.url).then((t=>t.blob())).then((t=>new Promise((e=>{const i=new FileReader;i.onload=()=>e(i.result),i.readAsDataURL(t)})))).catch(console.error);return{startPoint:this.startPoint,diminished:this.diminished.getData(),url:t}},createOfflineSource(t,e,i,s){if(i>this.endTime)return;const a=t.createBufferSource();let o,n,r;a.buffer=this.data.buffer,a.connect(e),i<this.startTime?(o=this.startTime-i,n=this.diminished.leftTime,r=s<this.endTime?s-this.startTime:this.duration):(o=0,n=i-this.initStartTime,r=s<this.endTime?s-i:this.endTime-i),a.start(o,n,r)}}};yt.render=function(t,e,i,s,a,o){const n=x("ContextMenu");return h(),d(g,null,[u("canvas",{class:"audio-canvas",tabindex:"-1",style:a.styles,width:a._width,height:"120",onKeydown:e[1]||(e[1]=y(l((e=>t.$emit("remove")),["stop"]),["delete"])),onContextmenu:e[2]||(e[2]=(...e)=>t.$refs.menu.show&&t.$refs.menu.show(...e)),onTouchstart:e[3]||(e[3]=(...e)=>t.$refs.menu.show&&t.$refs.menu.show(...e)),ref:"canvas"},null,44,["width"]),u(n,{ref:"menu"},{default:B((()=>[u("li",{onClick:e[4]||(e[4]=l(((...t)=>o.downloadAudioFile&&o.downloadAudioFile(...t)),["stop"]))},"ダウンロード"),u("li",{onClick:e[5]||(e[5]=l((e=>t.$emit("remove")),["stop"]))},"削除")])),_:1},512)],64)};const xt={name:"TrackAudioContainer",components:{DraftCanvas:wt,AudioCanvas:yt},props:["audioCtx","nextNode","sourceNode","pointer"],emits:["track-selected"],data:()=>({audioParamStack:[],lastAudioId:0,audioStack:[]}),created(){this.initRecorder()},methods:{setAudioRef(t){t&&!this.audioStack.includes(t)&&this.audioStack.push(t)},createAudioCanvas(t){this.audioStack=[],t.id=this.lastAudioId,this.audioParamStack.push(t),this.lastAudioId++},removeAudioCanvas(t){window.confirm("選択されているオーディオを削除しますか？")&&(this.audioStack=[],this.audioParamStack.splice(t,1))},initRecorder(){let t,e;this.recorder=new G(this.audioCtx,this.sourceNode),this.recorder.onstart=()=>{t=this.pointer.x,this.$refs.draftCanvas.show(t);let i=()=>{this.$refs.draftCanvas.draw(),e=requestAnimationFrame(i)};e=requestAnimationFrame(i)},this.recorder.onstop=i=>{cancelAnimationFrame(e),this.createAudioCanvas({startPoint:t,url:i}),this.$refs.draftCanvas.hide()}},startRecording(){this.recorder.start()},stopRecording(){this.recorder.stop()},getCurrentAudio(t){return this.audioStack.find((e=>e&&e.startPoint<=t&&e.endPoint>=t))},play(){const t=()=>{var e;const i=this.pointer.x,s=this.getCurrentAudio(i);s&&s!==this.currentAudio&&(null==(e=this.currentAudio)||e.pause(),this.currentAudio=s,this.currentAudio.play(i,(()=>this.currentAudio=null))),this.playId=requestAnimationFrame(t)};this.playId=requestAnimationFrame(t)},pause(){var t;cancelAnimationFrame(this.playId),null==(t=this.currentAudio)||t.pause(),this.currentAudio=null},getDownloadData(t){return this.audioStack.map(((e,i)=>e.getDownloadData(t,i)))},getUploadData(){return this.audioStack.map((t=>t.getUploadData()))},createOffline(t,e,i,s){this.audioStack.forEach((a=>a.createOfflineSource(t,e,i,s)))}}};xt.render=function(t,e,i,s,a,o){const n=x("DraftCanvas"),r=x("AudioCanvas");return h(),d("div",{class:"track_audio_container",onPointerdown:e[2]||(e[2]=e=>t.$emit("track-selected",e.shiftKey)),ref:"domElement"},[u(n,{audioCtx:i.audioCtx,sourceNode:i.sourceNode,ref:"draftCanvas"},null,8,["audioCtx","sourceNode"]),(h(!0),d(g,null,w(a.audioParamStack,((s,a)=>(h(),d(r,{key:s.id,initConfig:s,audioCtx:i.audioCtx,nextNode:i.nextNode,ref:o.setAudioRef,onTrackSelected:e[1]||(e[1]=e=>t.$emit("track-selected",e)),onRemove:t=>o.removeAudioCanvas(a)},null,8,["initConfig","audioCtx","nextNode","onRemove"])))),128))],544)};const Ct={name:"Track",components:{TrackLabel:ct,TrackAudioContainer:xt},props:["data","audioCtx","sourceNode","pointer"],emits:["track-solo","track-remove"],created(){this.gainNode=this.audioCtx.createGain(),this.gainNode.gain.value=.5,this.pannerNode=this.audioCtx.createStereoPanner(),this.muteNode=this.audioCtx.createGain(),this.soloNode=this.audioCtx.createGain(),this.gainNode.connect(this.pannerNode).connect(this.muteNode).connect(this.soloNode).connect(this.audioCtx.destination)},mounted(){var t,e,i;this.name=(null==(e=this.data.name)?void 0:e.substring((null==(t=this.data)?void 0:t.name.indexOf("_"))+1))||"新規トラック",this.gain=this.data.gain||.5,this.pan=this.data.pan||0,null==(i=this.data.audioStack)||i.forEach((t=>this.$refs.container.createAudioCanvas(t))),this.$watch("isMonitoring",(t=>{if(t)this.sourceNode.connect(this.gainNode);else try{this.sourceNode.disconnect(this.gainNode)}catch(e){}})),this.select()},unmounted(){try{this.sourceNode.disconnect(this.gainNode)}catch(t){}this.soloNode.disconnect()},computed:{name:{get:function(){return this.$refs.label.$refs.trackName.value},set:function(t){this.$refs.label.$refs.trackName.value=t}},gain:{get:function(){return this.gainNode.gain.value},set:function(t){this.$refs.label.gainValue=t}},pan:{get:function(){return this.pannerNode.pan.value},set:function(t){this.$refs.label.panValue=t}},isSelected:{get:function(){return this.$refs.label.isSelected},set:function(t){this.$refs.label.isSelected=t}},isMonitoring:{get:function(){return this.$refs.label.isMonitoring},set:function(t){this.$refs.label.isMonitoring=t}},isSolo(){return this.$refs.label.isSolo}},methods:{select(t){t||this.$parent.tracks.forEach((t=>{t.isSelected=!1})),this.isSelected=!0},startRecording(){this.$refs.container.startRecording()},stopRecording(){this.$refs.container.stopRecording()},play(){this.$refs.container.play()},pause(){this.$refs.container.pause()},async getDownloadData(t,e){const i=e+"_"+this.name;return{name:i,gain:this.gain,pan:this.pan,audioStack:await Promise.all(this.$refs.container.getDownloadData(t.folder(i)))}},async getUploadData(){return{name:this.name,gain:this.gain,pan:this.pan,audioStack:await Promise.all(this.$refs.container.getUploadData())}},createOffline(t,e,i){const s=t.createGain();s.gain.value=this.gain;const a=t.createStereoPanner();a.pan.value=this.pan,s.connect(a),a.connect(t.destination),this.$refs.container.createOffline(t,s,e,i)}}};Ct.render=function(t,e,i,s,a,o){const n=x("TrackLabel"),r=x("TrackAudioContainer");return h(),d(g,null,[(h(),d(P,{to:"#label_field"},[u(n,{gainNode:t.gainNode,pannerNode:t.pannerNode,muteNode:t.muteNode,ref:"label",onTrackSelected:o.select,onTrackSolo:e[1]||(e[1]=e=>t.$emit("track-solo")),onTrackRemove:e[2]||(e[2]=e=>t.$emit("track-remove"))},null,8,["gainNode","pannerNode","muteNode","onTrackSelected"])])),(h(),d(P,{to:"#ruler_layer"},[u(r,{audioCtx:i.audioCtx,nextNode:t.gainNode,sourceNode:i.sourceNode,pointer:i.pointer,ref:"container",onTrackSelected:o.select},null,8,["audioCtx","nextNode","sourceNode","pointer","onTrackSelected"])]))],64)};const Bt={name:"Editor",components:{Count:W,Rhythm:Z,Bpm:tt,Resizer:et,AddTrackBtn:it,Ruler:at,Pointer:nt,Track:Ct},props:["socket"],data:()=>({trackParams:[],lastTrackId:0,tracks:[],audioCtx:null,sourceNode:null,state:null}),created(){this.audioCtx=new(window.AudioContext||window.webkitAudioContext),this.audioCtx.onstatechange=()=>{"running"!==this.audioCtx.state&&this.audioCtx.resume()}},mounted(){const t=this.$refs.label_field,e=this.$refs.pointer_layer,i=this.$refs.ruler_layer;t.onscroll=e=>i.scrollTop=t.scrollTop,i.onscroll=e=>t.scrollTop=i.scrollTop;let s;e.onclick=t=>{"recording"!==this.state&&(this.$refs.pointer.layerX=t.clientX-200+e.scrollLeft,this.$refs.count.setNumberFromPointerX(this.$refs.pointer.x),"playing"===this.state&&(this.pause(),this.play()))};const a=t=>{const e=t[0].clientX,i=t[0].clientY,s=t[1].clientX,a=t[1].clientY;return Math.sqrt(Math.pow(s-e,2),Math.pow(a-i))};i.ontouchstart=t=>{"recording"!==this.state&&2===t.touches.length&&(s=a(t.touches))},i.ontouchmove=t=>{if("recording"===this.state||2!==t.touches.length)return;t.preventDefault();const e=a(t.touches),i=Math.round(this.$store.state.beat_interval*e/s);10<i&&i<100&&(this.$refs.resizer.value=i,this.$store.commit("beat_interval",i),s=e)},document.ondragover=t=>{t.stopPropagation(),t.preventDefault()},document.ondrop=async t=>{var e,i;t.stopPropagation(),t.preventDefault();const s=t.dataTransfer.items;if(1===s.length){const t=s[0],a=(null==(e=t.getAsEntry)?void 0:e.call(t))||(null==(i=t.webkitGetAsEntry)?void 0:i.call(t));if(a.isFile)a.file((async t=>{if(this.isAudioFile(t))this.loadAudioFile(t);else if("application/zip"===t.type){const e=await this.readProjectZip(t);this.loadProject(e)}}),console.error);else if(a.isDirectory){const t=await this.readProjectDirectory(a);this.loadProject(t)}}},document.onkeydown=t=>{switch(t.key){case"r":"recording"!==this.state&&this.startRecording();break;case"Backspace":"recording"!==this.state&&this.removeSelectedTracks();break;case" ":switch(t.preventDefault(),this.state){case"preparing":case"recording":this.stopRecording();break;case"playing":this.pause();break;default:this.play()}}}},methods:{setTrackRef(t){t&&!this.tracks.includes(t)&&this.tracks.push(t)},async getStream(){await navigator.mediaDevices.getUserMedia({video:!1,audio:{autoGainControl:!1,echoCancellation:!1,noiseSuppression:!1,sampleRate:44100}}).then((t=>{this.sourceNode=this.audioCtx.createMediaStreamSource(t),this.$parent.stream=t})).catch((t=>window.alert("マイク入力を取得できません。")))},async init(){var t,e;(null==(e=null==(t=this.sourceNode)?void 0:t.mediaStream)?void 0:e.active)||await this.getStream()},async addTrack(t={}){var e,i;await this.init(),(null==(i=null==(e=this.sourceNode)?void 0:e.mediaStream)?void 0:i.active)&&(this.tracks=[],t.id=this.lastTrackId,this.trackParams.push(t),this.lastTrackId++)},async addTrackByUser(t){await this.addTrack(t),this.socket.connected&&this.$nextTick((async function(){this.socket.send({type:"addTrack",trackData:await this.tracks[this.tracks.length-1].getUploadData()})}))},removeTrack(t){this.tracks=[],this.trackParams.splice(t,1)},removeTrackByUser(t){window.confirm("選択されているトラックを削除しますか？")&&(this.removeTrack(t),this.socket.connected&&this.$nextTick((function(){this.socket.send({type:"removeTrack",index:t})})))},removeSelectedTracks(){this.tracks.filter((t=>t.isSelected)).map((t=>this.trackParams.findIndex((e=>e.id===t.data.id)))).sort(((t,e)=>e-t)).forEach((t=>this.removeTrackByUser(t)))},makeTracksSolo(){this.tracks.every((t=>!1===t.isSolo))?this.tracks.forEach((t=>t.soloNode.gain.value=1)):this.tracks.forEach((t=>t.soloNode.gain.value=t.isSolo?1:0))},onPointerMove({layerX:t,x:e}){const i=this.$refs.pointer_layer;"recording"===this.state&&t-i.scrollLeft>i.offsetWidth&&(i.scrollLeft+=i.offsetWidth),e>=this.$store.getters.ruler_width&&this.$store.commit("addNumberOfBars",30)},async startRecording(){await this.init(),this.selectedTracks=this.tracks.filter((t=>t.isSelected));const t=this.tracks.filter((t=>!t.isSelected));this.selectedTracks.length&&("playing"===this.state&&this.pause(),this.$refs.pointer.prepareRecording(),this.$refs.count.setNumberFromPointerX(this.$refs.pointer.x),this.$refs.count.start(),this.$refs.pointer.start(),t.forEach((t=>t.play())),this.state="preparing",setTimeout((()=>{"preparing"===this.state&&(this.state="recording",this.$refs.bpm.disabled=!0,this.$refs.resizer.disabled=!0,this.selectedTracks.forEach((t=>t.startRecording())))}),1e3*this.$store.getters.getTimeOfDistance(this.$store.getters.bar_width)))},stopRecording(){"recording"===this.state&&(this.$refs.bpm.disabled=!1,this.$refs.resizer.disabled=!1,this.selectedTracks.forEach((t=>t.stopRecording())),this.socket.connected&&this.$nextTick((function(){this.sendAudioDataArray()}))),this.pause()},async play(){await this.init(),this.tracks.forEach((t=>t.play()));const t=this.$store.getters.scale_interval,e=this.$refs.pointer.x,i=e>0?t-e%t:-e%t,s=this.$store.getters.getTimeOfDistance(i);this.$refs.count.start(s),this.$refs.pointer.start(),this.state="playing"},pause(){this.tracks.forEach((t=>t.pause())),this.$refs.count.stop(),this.$refs.pointer.stop(),this.state=null},async sendAudioDataArray(){const t=await Promise.all(this.selectedTracks.map((async t=>{const e=t.$refs.container.audioStack;return{index:this.tracks.indexOf(t),data:await e[e.length-1].getUploadData()}})));this.socket.send({type:"addAudio",audioDataArray:t})},acceptAudioDataArray(t){t.forEach((t=>{this.tracks[t.index].$refs.container.createAudioCanvas(t.data)}))},isAudioFile:t=>"audio"===t.type.split("/")[0],async loadAudioFile(t){await this.addTrackByUser({audioStack:[{startPoint:0,url:window.URL.createObjectURL(t)}]})},download(t,e){const i=document.createElement("a");i.href=t,i.download=e,i.click()},downloadProject(){this.getDownloadData().then((t=>this.download(URL.createObjectURL(t),"project.zip")))},getProjectConfig(){const t=this.$store.state;return{rhythm:t.rhythm,bpm:t.bpm,beat_interval:t.beat_interval,number_of_bars:t.number_of_bars}},setProjectConfig(t){this.$refs.rhythm.init(t.rhythm),this.$refs.bpm.init(t.bpm),this.$refs.resizer.init(t.beat_interval),this.$store.commit("number_of_bars",Number(t.number_of_bars))},async getDownloadData(){const t=new D,e=JSON.stringify(c(r({},this.getProjectConfig()),{tracks:await Promise.all(this.tracks.map(((e,i)=>e.getDownloadData(t,i))))}));return t.file("config.json",new Blob([e],{type:"application/json"})),t.generateAsync({type:"blob"})},async readProjectZip(t){const e={},i=[],s=await D.loadAsync(t);return s.forEach(((t,a)=>{if("config.json"===a.name)i.push(s.file(a.name).async("string").then((t=>e["config.json"]=JSON.parse(t))));else if(!a.dir){let t=e;const o=a.name.split("/"),n=o.pop();o.forEach((e=>{t[e]||(t[e]={}),t=t[e]})),i.push(s.file(a.name).async("blob").then((e=>t[n]=URL.createObjectURL(e))))}})),await Promise.all(i),e},async readProjectDirectory(t){const e={};return await new Promise((i=>function t(e,i,s){e.isFile?e.file((t=>{if("config.json"===t.name){const e=new FileReader;e.onload=t=>{i["config.json"]=JSON.parse(e.result),s()},e.readAsText(t)}else i[t.name]=URL.createObjectURL(t)}),console.error):e.isDirectory&&(i[e.name]={},e.createReader().readEntries((a=>a.forEach((a=>t(a,i[e.name],s)))),console.error))}(t,e,i))),Object.values(e)[0]},loadProject(t){this.trackParams=[],this.$nextTick((async()=>{const e=t["config.json"];this.setProjectConfig(e);for await(let i of e.tracks)i.audioStack.forEach(((e,s)=>{e.url=t[i.name][s+".wav"]})),await this.addTrackByUser(i)}))},async getUploadData(){return c(r({},this.getProjectConfig()),{tracks:await Promise.all(this.tracks.map((t=>t.getUploadData())))})},loadSharedProject(t){this.trackParams=[],this.$nextTick((async()=>{this.setProjectConfig(t);for await(let e of t.tracks)await this.addTrack(e);console.info("プロジェクトに参加しました。")}))},getTimeFromBarAndBeat(t){const e=this.$store.state,i=(t.bar*e.rhythm[0]+t.beat-1)*this.$store.getters.scale_interval;return this.$store.getters.getTimeOfDistance(i)},writeProjectAudio(t){const e=this.getTimeFromBarAndBeat(t.start),i=this.getTimeFromBarAndBeat(t.stop),s=(i-e)*this.audioCtx.sampleRate,a=new(window.OfflineAudioContext||window.webkitOfflineAudioContext)(2,s,this.audioCtx.sampleRate);this.tracks.forEach((t=>t.createOffline(a,e,i))),a.startRendering().then((t=>this.download(X.AudioBuffer2WavFile(t),"project.wav"))).catch(console.error)}}},Pt={id:"header"},Dt={id:"label_field",class:"no-scroll-bar",ref:"label_field"},St={id:"pointer_layer",class:"no-scroll-bar",ref:"pointer_layer"},It={id:"ruler_layer",class:"no-scroll-bar",ref:"ruler_layer"};Bt.render=function(t,e,i,s,a,o){const n=x("Count"),r=x("Rhythm"),c=x("Bpm"),l=x("Resizer"),p=x("AddTrackBtn"),A=x("Pointer"),v=x("Ruler"),k=x("Track");return h(),d(g,null,[u("div",Pt,[u(n,{ref:"count",audioCtx:a.audioCtx},null,8,["audioCtx"]),u(r,{ref:"rhythm"},null,512),f(u("img",{src:"data:image/png;base64,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",class:"play-or-pause",onClick:e[1]||(e[1]=(...t)=>o.play&&o.play(...t))},null,512),[[m,null===a.state]]),f(u("img",{src:"/assets/pause.002d3fec.png",class:"play-or-pause",onClick:e[2]||(e[2]=(...t)=>o.pause&&o.pause(...t))},null,512),[[m,"playing"===a.state]]),u("button",{type:"button",id:"start",onClick:e[3]||(e[3]=t=>"preparing"===a.state||"recording"===a.state?o.stopRecording():o.startRecording())},"R"),u(c,{ref:"bpm"},null,512),u(l,{ref:"resizer"},null,512)]),u("div",Dt,[u(p,{onAddTrack:o.addTrackByUser},null,8,["onAddTrack"])],512),u("div",St,[u(A,{margin:20,onMove:o.onPointerMove,ref:"pointer"},null,8,["onMove"]),u("div",It,[u(v,{ref:"ruler"},null,512)],512)],512),(h(!0),d(g,null,w(a.trackParams,((e,i)=>(h(),d(k,{key:e.id,data:e,audioCtx:a.audioCtx,sourceNode:a.sourceNode,pointer:t.$refs.pointer,ref:o.setTrackRef,onTrackSolo:o.makeTracksSolo,onTrackRemove:t=>o.removeTrackByUser(i)},null,8,["data","audioCtx","sourceNode","pointer","onTrackSolo","onTrackRemove"])))),128))],64)};const Tt={name:"App",components:{SideMenu:O,VideoContainer:R,Popup:U,WriteRange:Q,Editor:Bt},data:()=>({isShowPopup:!1,popUpType:null,projectId:null,socket:null,stream:null}),created(){this.socket=new $},mounted(){window.onpopstate=t=>t.preventDefault(),window.onbeforeunload=t=>{t.preventDefault(),t.returnValue="ページを移動すると全てのデータが失われます。"},window.onorientationchange=this.alertScreenOrientation,window.onload=this.alertScreenOrientation,window.ontouchmove=t=>t.preventDefault(),this.socket.init((async t=>{switch(t.type){case"joinProject":this.socket.send({type:"shareProject",target:t.target,projectData:await this.$refs.editor.getUploadData()});break;case"addTrack":this.$refs.editor.addTrack(t.trackData);break;case"removeTrack":this.$refs.editor.removeTrack(t.index);break;case"addAudio":this.$refs.editor.acceptAudioDataArray(t.audioDataArray)}}))},methods:{alertScreenOrientation(){var t,e;const i=(null==(e=null==(t=window.screen)?void 0:t.orientaion)?void 0:e.angle)||window.orientation;window.screen.width<550&&0===i&&alert("画面を横向きにしてください。")},startProject(){this.projectId="loading",this.socket.connect(),this.socket.onclose=t=>this.projectId=null,this.socket.onerror=t=>this.projectId=null,this.socket.onopen=()=>{this.socket.send({type:"startProject"}),this.socket.onmessage=t=>{"id"===t.type&&(this.projectId=t.id,console.info("プロジェクトを共有しました。id: "+this.projectId)),this.socket.setDefault()}}},joinProject(){this.projectId="loading";const t=this.$refs.projectIdField.value;this.socket.connect(),this.socket.onclose=t=>this.projectId=null,this.socket.onerror=t=>this.projectId=null,this.socket.onopen=()=>{this.socket.send({type:"joinProject",id:t}),this.socket.onmessage=e=>{"shareProject"===e.type&&(this.projectId=t,this.$refs.editor.loadSharedProject(e.projectData)),this.socket.setDefault()}}},endProject(){this.socket.close(),this.$refs.videoContainer.room.close()}}},Nt=I("プロジェクトに参加"),jt=u("br",null,null,-1),$t={key:1},Et=u("a",{href:"/docs/",target:"_blank"},"ヘルプ",-1);Tt.render=function(t,e,i,s,a,o){const n=x("VideoContainer"),r=x("SideMenu"),c=x("WriteRange"),l=x("Popup"),p=x("Editor");return h(),d(g,null,[u(r,null,{default:B((()=>[u("a",{onClick:e[1]||(e[1]=(...e)=>t.$refs.editor.downloadProject&&t.$refs.editor.downloadProject(...e))},"プロジェクトファイルをダウンロード"),u("a",{onClick:e[2]||(e[2]=t=>{a.isShowPopup=!0,a.popUpType="WriteRange"})},"選択範囲を書き出す"),null===a.projectId?(h(),d(g,{key:0},[u("a",{onClick:e[3]||(e[3]=(...t)=>o.startProject&&o.startProject(...t))},"プロジェクトを共有"),u("a",null,[Nt,jt,u("textarea",{cols:"2",rows:"1",onKeydown:e[4]||(e[4]=y(((...t)=>o.joinProject&&o.joinProject(...t)),["enter"])),ref:"projectIdField"},null,544)])],64)):"loading"===a.projectId?(h(),d("a",$t,"Loading...")):(h(),d(g,{key:2},[u("a",null,"プロジェクトID: "+k(a.projectId),1),u("a",{onClick:e[5]||(e[5]=(...t)=>o.endProject&&o.endProject(...t))},"共有を停止する")],64)),Et,"loading"!==a.projectId&&null!==a.projectId?(h(),d(n,{key:3,stream:a.stream,roomId:a.projectId,ref:"videoContainer"},null,8,["stream","roomId"])):S("",!0)])),_:1}),f(u(l,{onHidePopup:e[7]||(e[7]=t=>a.isShowPopup=!1)},{default:B((()=>["WriteRange"===a.popUpType?(h(),d(c,{key:0,onHidePopup:e[6]||(e[6]=t=>a.isShowPopup=!1),onWriteProject:t.$refs.editor.writeProjectAudio},null,8,["onWriteProject"])):S("",!0)])),_:1},512),[[m,a.isShowPopup]]),u(p,{socket:a.socket,ref:"editor"},null,8,["socket"])],64)};const Ot=T({state:()=>({rhythm:[4,4],bpm:120,beat_interval:20,number_of_bars:30}),getters:{animation_width:t=>t.bpm/60*t.beat_interval/60,second_width:(t,e)=>t.bpm/60*t.beat_interval,scale_interval:t=>4*t.beat_interval/t.rhythm[1],bar_width:(t,e)=>e.scale_interval*t.rhythm[0],ruler_width:(t,e)=>e.bar_width*t.number_of_bars,getNumberOfBarsFromDuration:t=>e=>{const i=4*t.rhythm[0]/t.rhythm[1],s=t.bpm/60;return Math.ceil(e*s/i)},getTimeOfDistance:t=>e=>60/t.bpm*e/t.beat_interval},mutations:{rhythm:(t,e)=>t.rhythm=e,bpm:(t,e)=>t.bpm=e,beat_interval:(t,e)=>t.beat_interval=e,number_of_bars:(t,e)=>t.number_of_bars=e,addNumberOfBars:(t,e)=>t.number_of_bars+=e}});N(Tt).use(Ot).mount("#app");

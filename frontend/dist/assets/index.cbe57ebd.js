var t=Object.defineProperty,e=Object.defineProperties,i=Object.getOwnPropertyDescriptors,s=Object.getOwnPropertySymbols,a=Object.prototype.hasOwnProperty,n=Object.prototype.propertyIsEnumerable,o=(e,i,s)=>i in e?t(e,i,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[i]=s,r=(t,e)=>{for(var i in e||(e={}))a.call(e,i)&&o(t,i,e[i]);if(s)for(var i of s(e))n.call(e,i)&&o(t,i,e[i]);return t},c=(t,s)=>e(t,i(s));import{o as d,c as h,w as l,a as u,b as m,v as p,r as f,F as g,P as v,n as w,d as k,e as y,f as A,g as b,t as C,h as x,i as T,j as S,k as D,l as B,m as I,p as P,T as N,W as $,J as j,q as M,s as R,u as O,x as U,y as E,z as _}from"./vendor.9f618e4e.js";!function(){const t=document.createElement("link").relList;if(!(t&&t.supports&&t.supports("modulepreload"))){for(const t of document.querySelectorAll('link[rel="modulepreload"]'))e(t);new MutationObserver((t=>{for(const i of t)if("childList"===i.type)for(const t of i.addedNodes)"LINK"===t.tagName&&"modulepreload"===t.rel&&e(t)})).observe(document,{childList:!0,subtree:!0})}function e(t){if(t.ep)return;t.ep=!0;const e=function(t){const e={};return t.integrity&&(e.integrity=t.integrity),t.referrerpolicy&&(e.referrerPolicy=t.referrerpolicy),"use-credentials"===t.crossorigin?e.credentials="include":"anonymous"===t.crossorigin?e.credentials="omit":e.credentials="same-origin",e}(t);fetch(t.href,e)}}();class F{constructor(t=8){this.idLength=t,this.ch_list=[];for(let e=0;e<26;e++)this.ch_list.push(String.fromCharCode("a".charCodeAt(0)+e));for(let e=0;e<26;e++)this.ch_list.push(String.fromCharCode("A".charCodeAt(0)+e));for(let e=0;e<10;e++)this.ch_list.push(String(e));this.store=new Set}generateId(t=this.idLength){let e="";for(let i=0;i<t;i++)e+=this.ch_list[Math.floor(Math.random()*this.ch_list.length)];return this.store.has(e)?this.generateId(t):(this.store.add(e),e)}removeId(t){this.store.has(t)&&this.store.delete(t)}storeId(t){this.store.has(t)||this.store.add(t)}}const V=class{constructor(){this.packetIdManager=new F(8),this.packetBuffer=new Map}init(t){this.defaultOnmessage=t}connect(){this.socket=new WebSocket(`${"https:"===location.protocol?"wss":"ws"}://${location.host}/websocket`),this.connected=!0}setDefault(){this.onmessage=t=>this.defaultOnmessage(t)}generatePacketId(){const t=this.packetIdManager.generateId();return this.packetBuffer.has(t)?(F.removeId(t),this.generatePacketId()):t}send(t){const e=JSON.stringify(t);if(e.length>V.MAX_DATA_SIZE){this.lastSendDataBlobURL&&URL.revokeObjectURL(this.lastSendDataBlobURL),this.lastSendDataBlobURL=URL.createObjectURL(new Blob([e],{type:"application/json"}));const i=this.generatePacketId(8),s=Math.ceil(e.length/V.MAX_DATA_SIZE);for(let a=0;a<s;a++){const n=a*V.MAX_DATA_SIZE;let o=n+V.MAX_DATA_SIZE;o>e.length&&(o=e.length),this.socket.send(JSON.stringify({type:"packet",target:t.target,packetId:i,numOfPackets:s,index:a,body:e.slice(n,o)}))}}else this.socket.send(e)}close(){var t;null==(t=this.socket)||t.close()}set onopen(t){this.socket.onopen=e=>{this.socket.send(JSON.stringify({type:"ping"})),console.info("接続しました。"),t(e)}}set onmessage(t){this.socket.onmessage=e=>{const i=JSON.parse(e.data);if("pong"!==i.type)switch(console.log(i),i.type){case"packet":if(this.packetBuffer.has(i.packetId)||this.packetBuffer.set(i.packetId,new Array(i.numOfPackets).fill(void 0)),this.packetBuffer.get(i.packetId)[i.index]=i,this.packetBuffer.get(i.packetId).every((t=>t))){const e=JSON.parse(this.packetBuffer.get(i.packetId).reduce(((t,e)=>t+e.body),""));t(e),this.packetBuffer.delete(i.packetId)}break;case"packet_id_overlapped_error":const e=new FileReader;e.onload((()=>this.send(JSON.parse(e.result)))),e.readAsText(this.lastSendDataBlobURL);break;case"msg":console.info(i.msg);break;default:t(i)}else this.socket.send(JSON.stringify({type:"ping"}))}}set onclose(t){this.socket.onclose=e=>{t(e),this.connected=!1,console.info("接続が閉じられました。")}}set onerror(t){this.socket.onerror=e=>{t(e),this.connected=!1,console.error(e)}}};let L=V;var Q;o(L,"symbol"!=typeof(Q="MAX_DATA_SIZE")?Q+"":Q,1e7);var z=(t,e)=>{for(const[i,s]of e)t[i]=s;return t};const H=["fill","stroke"];var W=z({name:"SideMenu",data:()=>({isShow:!1}),mounted(){document.onclick=t=>this.isShow=!1}},[["render",function(t,e,i,s,a,n){return d(),h(g,null,[(d(),h("svg",{id:"menu-btn",onClick:e[0]||(e[0]=l((t=>a.isShow=!a.isShow),["stop"]))},[u("use",{href:"/assets/hamburger.dab2f6d8.svg#hamburger",fill:a.isShow?"#323232":"white",stroke:a.isShow?"#323232":"white"},null,8,H)])),m(u("div",{id:"side-menu",onClick:e[1]||(e[1]=l((()=>{}),["stop"])),onKeydown:e[2]||(e[2]=l((()=>{}),["stop"]))},[f(t.$slots,"default")],544),[[p,a.isShow]])],64)}]]);const X={id:"video-container"},Y={id:"local-video",autoplay:"",muted:"",playsinline:"",ref:"localVideo"};var G=z({name:"VideoContainer",props:{roomId:String},data:()=>({videoOn:!0,audioOn:!0,videoParams:[],videos:[],stream:null,room:null}),async mounted(){this.stream=await this.getStream(),this.$refs.localVideo.srcObject=this.stream;const t=new v({key:"8ce51882-3317-4964-99cc-a7e50809042a",debug:2});t.on("open",(()=>{this.room=t.joinRoom(this.roomId,{mode:"sfu",stream:this.stream}),this.room.once("open",(()=>console.log("=== You joined ==="))),this.room.on("peerJoin",(t=>console.log(`=== ${t} joined ===`))),this.room.on("stream",(async t=>{this.videoParams.push({peerId:t.peerId}),this.$nextTick((function(){this.videos[this.videos.length-1].srcObject=t,this.videos[this.videos.length-1].peerId=t.peerId}))})),this.room.on("data",(({data:t,src:e})=>console.log(`${e}: ${t}`))),this.room.on("peerLeave",(t=>{var e;const i=this.videos.find((e=>e.peerId===t));null==(e=i.srcObject)||e.getTracks().forEach((t=>t.stop())),i.srcObject=null,this.videos=[];const s=this.videoParams.indexOf((e=>e.peerId===t));this.videoParams.splice(s,1),console.log(`=== ${t} left ===`)})),this.room.once("close",(()=>{var t;console.log("== You left ==="),this.videos.forEach((t=>{var e;null==(e=t.srcObject)||e.getTracks().forEach((t=>t.stop())),t.srcObject=null})),null==(t=this.$refs.localVideo.srcObject)||t.getTracks().forEach((t=>t.stop())),this.$refs.localVideo.srcObject=null,this.videoParams=[]}))})),t.on("error",console.error)},watch:{videoOn(t){this.stream.getVideoTracks()[0].enabled=t},audioOn(t){this.stream.getAudioTracks()[0].enabled=t}},methods:{getStream:()=>navigator.mediaDevices.getUserMedia({video:{aspectRatio:1920/1080},audio:!0}).catch((t=>window.alert("カメラ・マイク入力を取得できません。"))),setVideoRef(t){t&&!this.videos.includes(t)&&this.videos.push(t)}}},[["render",function(t,e,i,s,a,n){return d(),h("div",X,[u("video",Y,null,512),u("button",{type:"button",class:w(["video-btn",{active:a.videoOn}]),onClick:e[0]||(e[0]=t=>a.videoOn=!a.videoOn),ref:"videoBtn"},"video",2),u("button",{type:"button",class:w(["video-btn",{active:a.audioOn}]),onClick:e[1]||(e[1]=t=>a.audioOn=!a.audioOn),ref:"audioBtn"},"audio",2),(d(!0),h(g,null,k(a.videoParams,(t=>(d(),h("video",{class:"member-video",autoplay:"",playsinline:"",key:t.peerId,ref:n.setVideoRef},null,512)))),128))])}]]);var J=z({name:"Dialog",emits:["hide-dialog"]},[["render",function(t,e,i,s,a,n){return d(),h("div",{id:"dialog-background",onClick:e[1]||(e[1]=l((e=>t.$emit("hide-dialog")),["stop"])),onKeydown:e[2]||(e[2]=l((()=>{}),["stop"]))},[u("div",{id:"dialog",onClick:e[0]||(e[0]=l((()=>{}),["stop"]))},[f(t.$slots,"default")])],32)}]]);const q={name:"ChooseTrackComponent",emits:["choose-track-component","hide-dialog"],data:()=>({component:"AudioTrack"}),methods:{chooseTrackType(){this.$emit("choose-track-component",this.component),this.$emit("hide-dialog")}}},K={id:"choose-track-component-container"},Z=A("オーディオ"),tt=A("ビデオ"),et=A("MIDI"),it=u("button",{type:"submit"},"決定",-1);var st=z(q,[["render",function(t,e,i,s,a,n){return d(),h("div",K,[u("form",{onSubmit:e[4]||(e[4]=l(((...t)=>n.chooseTrackType&&n.chooseTrackType(...t)),["prevent"]))},[u("p",null,[u("label",null,[m(u("input",{type:"radio",name:"track",value:"AudioTrack",required:"","onUpdate:modelValue":e[0]||(e[0]=t=>a.component=t),checked:""},null,512),[[y,a.component]]),Z])]),u("p",null,[u("label",null,[m(u("input",{type:"radio",name:"track",value:"VideoTrack",required:"","onUpdate:modelValue":e[1]||(e[1]=t=>a.component=t)},null,512),[[y,a.component]]),tt])]),u("p",null,[u("label",null,[m(u("input",{type:"radio",name:"track",value:"MidiTrack",required:"","onUpdate:modelValue":e[2]||(e[2]=t=>a.component=t)},null,512),[[y,a.component]]),et])]),u("p",null,[it,u("button",{type:"button",onClick:e[3]||(e[3]=e=>t.$emit("hide-dialog"))},"中止")])],32)])}]]);const at={name:"WriteRange",emits:["write-project","hide-dialog"],data:()=>({startBar:"",startBeat:"",stopBar:"",stopBeat:""}),computed:{minBar:()=>0,maxBar(){return this.$store.state.number_of_bars},minBeat:()=>1,maxBeat(){return this.$store.state.rhythm[0]},maxStartBar(){return this.maxBar-1},minStopBar(){return this.startBeat==this.maxBeat?Number(this.startBar)+1:this.startBar},minStopBeat(){return this.startBar===this.stopBar?Number(this.startBeat)+1:1},maxStopBeat(){return this.startBar==this.maxStartBar?1:this.maxBeat}},methods:{writeProject(){const t=Object.freeze({bar:Number(this.startBar),beat:Number(this.startBeat)}),e=Object.freeze({bar:Number(this.stopBar),beat:Number(this.stopBeat)});this.$emit("write-project",{start:t,stop:e}),this.$emit("hide-dialog")},reset(){this.startBar="",this.startBeat="",this.stopBar="",this.stopBeat=""},hide(){this.reset(),this.$emit("hide-dialog")}}},nt={id:"write-range-container"},ot=u("tr",null,[u("th"),u("th",null,"小節"),u("th",null,"拍")],-1),rt=u("th",null,"start",-1),ct=["min","max"],dt=["min","max"],ht=u("th",null,"stop",-1),lt=["min","max"],ut=["min","max"],mt=u("button",{type:"submit"},"決定",-1);var pt=z(at,[["render",function(t,e,i,s,a,n){return d(),h("div",nt,[u("form",{onSubmit:e[5]||(e[5]=l(((...t)=>n.writeProject&&n.writeProject(...t)),["prevent"]))},[u("table",null,[ot,u("tr",null,[rt,u("td",null,[m(u("input",{type:"number",required:"",min:n.minBar,max:n.maxStartBar,"onUpdate:modelValue":e[0]||(e[0]=t=>a.startBar=t)},null,8,ct),[[b,a.startBar]])]),u("td",null,[m(u("input",{type:"number",required:"",min:n.minBeat,max:n.maxBeat,"onUpdate:modelValue":e[1]||(e[1]=t=>a.startBeat=t)},null,8,dt),[[b,a.startBeat]])])]),u("tr",null,[ht,u("td",null,[m(u("input",{type:"number",required:"",min:n.minStopBar,max:n.maxBar,"onUpdate:modelValue":e[2]||(e[2]=t=>a.stopBar=t)},null,8,lt),[[b,a.stopBar]])]),u("td",null,[m(u("input",{type:"number",required:"",min:n.minStopBeat,max:n.maxStopBeat,"onUpdate:modelValue":e[3]||(e[3]=t=>a.stopBeat=t)},null,8,ut),[[b,a.stopBeat]])])])]),u("p",null,[mt,u("button",{type:"button",onClick:e[4]||(e[4]=(...t)=>n.hide&&n.hide(...t))},"中止")])],32)])}]]);class ft{static AudioBuffer2WavFile(t,e,i){return ft.writeWav(ft.AudioBuffer2WavData(t,e,i),t.sampleRate)}static AudioBuffer2WavData(t,e,i){const s=Math.floor(e*t.sampleRate||0),a=Math.floor(i*t.sampleRate||t.length)-s,n=t.getChannelData(0),o=t.getChannelData(1),r=new Float32Array(2*a);for(let c=0;c<a;c++)r[2*c]=n[c+s],r[2*c+1]=o[c+s];return r}static writeWav(t,e){const i=new ArrayBuffer(44+2*t.length),s=new DataView(i);ft.writeWavHead(s,t.length,e),ft.writeWavData(s,t);const a=new Blob([s],{type:"audio/wav"});return URL.createObjectURL(a)}static writeWavHead(t,e,i){const s=function(t,e,i){for(let s=0;s<i.length;s++)t.setUint8(e+s,i.charCodeAt(s))};s(t,0,"RIFF"),t.setUint32(4,32+2*e,!0),s(t,8,"WAVE"),s(t,12,"fmt "),t.setUint32(16,16,!0),t.setUint16(20,1,!0),t.setUint16(22,2,!0),t.setUint32(24,i,!0),t.setUint32(28,2*i,!0),t.setUint16(32,2,!0),t.setUint16(34,16,!0),s(t,36,"data"),t.setUint32(40,2*e,!0)}static writeWavData(t,e){for(let i=0,s=44;i<e.length;i++,s+=2){let a=Math.max(-1,Math.min(1,e[i]));t.setInt16(s,a<0?32768*a:32767*a,!0)}}}function gt(t,e){return fetch(e).then((t=>t.arrayBuffer())).then((e=>t.decodeAudioData(e)))}class vt{constructor(t,e){this.audioBuffer=t,this.nextNode=e}createSource(){this.source=this.nextNode.context.createBufferSource(),this.source.buffer=this.audioBuffer,this.source.connect(this.nextNode)}play(t,e,i){this.createSource(),t&&e&&i?(this.source.onended=i,this.source.start(0,t,e-t)):this.source.start()}pause(){this.source&&(this.source.stop(),this.source.disconnect(),this.source=null)}}class wt extends AudioWorkletNode{constructor(t){super(t,"recorder-processor"),this.buffers=[],this.port.onmessage=t=>this.buffers.push(t.data)}mergeBuffers(t){const e=t.reduce(((t,e)=>t+e.length),0),i=new Float32Array(e);let s=0;for(let a=0;a<t.length;a++)for(let e=0;e<t[a].length;e++)i[s]=t[a][e],s++;return i}getData(){const t=this.mergeBuffers(this.buffers);return this.buffers=[],t}}class kt{constructor(t){this.audioCtx=t.context,this.sourceNode=t,this.recorderNode=new wt(this.audioCtx)}start(){this.onstart(),this.sourceNode.connect(this.recorderNode).connect(this.audioCtx.destination)}stop(){this.sourceNode.disconnect(this.recorderNode),this.recorderNode.disconnect(),this.onstop(ft.writeWav(this.recorderNode.getData(),this.audioCtx.sampleRate))}}const yt=["fill","stroke"],At={id:"count"};var bt=z({name:"Count",props:["audioCtx"],data:()=>({isMuted:!1,number:1}),async mounted(){const t=await gt(this.audioCtx,"/metronome.wav");this.player=new vt(t,this.audioCtx.destination)},computed:{rhythm(){return this.$store.state.rhythm},count_time(){return 60/this.$store.state.bpm*4/this.rhythm[1]}},methods:{start(t=0){setTimeout((()=>{0!==t?this.count():this.playMetronome(),this.countId=setInterval((()=>{this.count()}),1e3*this.count_time)}),1e3*t)},stop(){clearInterval(this.countId),this.player.pause()},count(){this.number==this.rhythm[0]?this.number=1:this.number++,this.playMetronome()},playMetronome(){this.isMuted||this.player.play()},setNumberFromPointerX(t){const e=this.$store.getters;this.number=Math.floor(t%e.bar_width/e.scale_width)+1,this.number<=0&&(this.number+=this.rhythm[0])}}},[["render",function(t,e,i,s,a,n){return d(),h(g,null,[(d(),h("svg",{id:"metronome",onClick:e[0]||(e[0]=t=>{a.isMuted=!a.isMuted})},[u("use",{href:"/assets/metronome.cb73d681.svg#metronome",fill:a.isMuted?"red":"white",stroke:a.isMuted?"red":"white"},null,8,yt)])),u("div",At,C(a.number),1)],64)}]]);var Ct=z({name:"Rhythm",inject:["socket"],data:()=>({value:"4/4"}),watch:{value(t){const e=t.split("/").map((t=>Number(t)));this.$store.commit("rhythm",e),this.socket.connected&&this.socket.send({type:"changeRhythm",value:e})}},methods:{init(t){this.$refs.inputElement.value=t.join("/"),this.$store.commit("rhythm",t.map((t=>Number(t))))}}},[["render",function(t,e,i,s,a,n){const o=x("InputElement");return d(),T(o,{type:"text",size:"3",modelValue:a.value,"onUpdate:modelValue":e[0]||(e[0]=t=>a.value=t),ref:"inputElement"},null,8,["modelValue"])}]]);var xt=z({name:"Bpm",inject:["socket"],data:()=>({value:"120",disabled:!1}),watch:{value(t){this.disabled?this.value=this.$store.state.bpm:(this.$store.commit("bpm",Number(t)),this.socket.connected&&this.socket.send({type:"changeBpm",value:t}))}},methods:{init(t){this.$refs.inputElement.value=t,this.$store.commit("bpm",Number(t))}}},[["render",function(t,e,i,s,a,n){const o=x("InputElement");return d(),T(o,{type:"number",size:"3",modelValue:a.value,"onUpdate:modelValue":e[0]||(e[0]=t=>a.value=t),disabled:a.disabled,ref:"inputElement"},null,8,["modelValue","disabled"])}]]);const Tt=["title","disabled"];var St=z({name:"Resizer",data:()=>({value:20,disabled:!1}),methods:{init(t){this.value=t,this.$store.commit("beat_width",Number(t))},valueChanged(){this.$store.commit("beat_width",Number(this.value))}}},[["render",function(t,e,i,s,a,n){return m((d(),h("input",{type:"range",min:"10",max:"100",step:"1",title:a.value,"onUpdate:modelValue":e[0]||(e[0]=t=>a.value=t),onInput:e[1]||(e[1]=(...t)=>n.valueChanged&&n.valueChanged(...t)),disabled:a.disabled},null,40,Tt)),[[b,a.value]])}]]);const Dt={id:"ruler",height:"30",ref:"canvas"};var Bt=z({name:"Ruler",mounted(){this.ctx=this.canvas.getContext("2d"),this.ctx.font="10px",this.draw()},computed:{rhythm(){return this.$store.state.rhythm},bpm(){return this.$store.state.bpm},beat_width(){return this.$store.state.beat_width},project_duration(){return this.$store.state.project_duration},canvas(){return this.$refs.canvas}},watch:{rhythm(){this.draw()},bpm(){this.draw()},beat_width(){this.draw()},project_duration(){this.draw()}},methods:{draw(){this.canvas.width=this.$store.getters.ruler_width,this.ctx.fillStyle="#323232",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.ctx.strokeStyle=this.ctx.fillStyle="#f0f0f0";const t=this.rhythm[0],e=this.$store.getters.scale_width;for(let i=0;i<this.canvas.width/e;i++){const s=i*e;this.ctx.beginPath(),i%t==0?(this.ctx.fillText(`${Math.floor(i/t)}`,s,12),this.ctx.moveTo(s,15)):this.ctx.moveTo(s,25),this.ctx.lineTo(s,30),this.ctx.stroke()}}}},[["render",function(t,e,i,s,a,n){return d(),h("canvas",Dt,null,512)}]]);var It=z({name:"Pointer",props:{margin:Number},data(){return{styles:{left:this.margin+"px"}}},mounted(){this.canvas.height=window.innerHeight-80,this.ctx=this.canvas.getContext("2d"),this.ctx.fillStyle="#f0f0f0",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height)},computed:{beat_width(){return this.$store.state.beat_width},canvas(){return this.$refs.canvas},layerX:{get(){return this.styles.left.slice(0,-2)-0},set(t){this.styles.left=t+"px"}},x:{get(){return this.layerX-this.margin},set(t){this.layerX=t+this.margin}},time(){return this.x/this.$store.getters.second_width}},watch:{beat_width(t,e){this.x*=t/e},x(t){this.$store.commit("pointer_x",t)}},methods:{start(){let t=()=>{this.move(),this.animationId=requestAnimationFrame(t)};this.animationId=requestAnimationFrame(t)},stop(){cancelAnimationFrame(this.animationId)},prepareRecording(){const t=this.$store.state.rhythm,e=this.$store.getters.scale_width;this.x>=0?this.x=(Math.floor(this.x/e)-t[0])*e:this.x=-t[0]*e},move(){this.$emit("move",{layerX:this.layerX,x:this.x}),this.x+=this.$store.getters.animation_width}}},[["render",function(t,e,i,s,a,n){return d(),h("canvas",{id:"pointer",style:S(a.styles),width:"2",ref:"canvas"},null,4)}]]);const Pt={props:{trackData:Object},inject:["socket"],emits:["track-remove"],provide(){return{trackId:this.trackData.id}},data(){var t,e;return{name:(null==(e=this.trackData.name)?void 0:e.substring((null==(t=this.trackData)?void 0:t.name.indexOf("_"))+1))||"新規トラック",isSelected:!0}},mounted(){var t;null==(t=this.trackData.canvases)||t.forEach((t=>this.$refs.container.createCanvas(t))),this.select(),this.$nextTick((async()=>{this.socket.connected&&this.trackData.send&&this.socket.send({type:"addTrack",trackData:await this.getUploadData()})}))},watch:{name(t){this.socket.connected&&this.socket.send({type:"changeTrackName",trackId:this.trackData.id,value:t})}},methods:{select(t=!1){t||this.$parent.tracks.forEach((t=>{t.isSelected=!1})),this.isSelected=!0},startRecording(){this.$refs.container.startRecording()},stopRecording(){this.$refs.container.stopRecording()},play(){this.$refs.container.play()},pause(){this.$refs.container.pause()}}};const Nt={name:"TrackLabel",props:{isSelected:Boolean},emits:["update:isSelected","track-select","track-remove"],methods:{select(t){this.$emit("update:isSelected",!0),this.$emit("track-select",t.shiftKey)}}},$t={class:"track-type"};var jt=z(Nt,[["render",function(t,e,i,s,a,n){const o=x("ContextMenu");return d(),h(g,null,[u("div",{class:w(["track-label",{"is-selected":i.isSelected}]),onPointerdown:e[0]||(e[0]=(...t)=>n.select&&n.select(...t)),onContextmenu:e[1]||(e[1]=(...e)=>t.$refs.menu.show&&t.$refs.menu.show(...e)),onTouchstart:e[2]||(e[2]=(...e)=>t.$refs.menu.show&&t.$refs.menu.show(...e))},[u("div",$t,[f(t.$slots,"track-type")]),u("div",null,[f(t.$slots,"contents")])],34),D(o,{ref:"menu"},{default:B((()=>[f(t.$slots,"menu"),u("li",{onClick:e[3]||(e[3]=l((e=>t.$emit("track-remove")),["stop"]))},"削除")])),_:3},512)],64)}]]);const Mt={name:"AudioTrackLabel",props:{trackType:String,name:String,gain:Number,pan:Number,isSelected:Boolean,isMonitoring:Boolean,isMuted:Boolean,isSolo:Boolean},emits:["update:name","update:gain","update:pan","update:isSelected","update:isMonitoring","update:isMuted","update:isSolo","track-select","track-remove"],components:{TrackLabel:jt},data:()=>({selectedSlider:"V"})},Rt={class:"track-slider-container"},Ot=[u("option",{selected:"",title:"音量"},"V",-1),u("option",{title:"パン"},"P",-1)],Ut=["value","title"],Et=["value","title"],_t={class:"track-btn-container"},Ft=[u("use",{href:"/assets/monitor_off.a262b164.svg#monitor_off",fill:"#323232"},null,-1)],Vt=[u("use",{href:"/assets/monitor_on.8ded233d.svg#monitor_on",fill:"red"},null,-1)],Lt=[u("use",{href:"/assets/volume_on.c661966d.svg#volume_on",fill:"#323232",stroke:"#323232"},null,-1)],Qt=[u("use",{href:"/assets/volume_off.f004657e.svg#volume_off",fill:"#323232",stroke:"#323232"},null,-1)];var zt=z(Mt,[["render",function(t,e,i,s,a,n){const o=x("InputElement"),r=x("TrackLabel");return d(),T(r,{isSelected:i.isSelected,"onUpdate:isSelected":e[7]||(e[7]=e=>t.$emit("update:isSelected",e)),onTrackSelect:e[8]||(e[8]=e=>t.$emit("track-select",e)),onTrackRemove:e[9]||(e[9]=e=>t.$emit("track-remove")),ref:"container"},{"track-type":B((()=>[A(C(i.trackType.slice(0,-5)),1)])),contents:B((()=>[D(o,{type:"text",size:"8",modelValue:i.name,"onUpdate:name":e[0]||(e[0]=e=>t.$emit("update:name",e))},null,8,["modelValue"]),u("div",Rt,[m(u("select",{"onUpdate:modelValue":e[1]||(e[1]=t=>a.selectedSlider=t)},Ot,512),[[I,a.selectedSlider]]),m(u("input",{type:"range",min:"0",max:"1",step:"0.05",value:String(i.gain),onInput:e[2]||(e[2]=e=>t.$emit("update:gain",Number(e.target.value))),title:"音量:"+i.gain},null,40,Ut),[[p,"V"===a.selectedSlider]]),m(u("input",{type:"range",min:"-1",max:"1",step:"0.1",value:String(i.pan),onInput:e[3]||(e[3]=e=>t.$emit("update:pan",Number(e.target.value))),title:"パン:"+i.pan},null,40,Et),[[p,"P"===a.selectedSlider]])]),u("div",_t,[u("button",{type:"button",class:"track-btn track-monitor-btn",onClick:e[4]||(e[4]=e=>{t.$emit("update:isMonitoring",!i.isMonitoring)}),title:"入力モニタリング"},[m((d(),h("svg",null,Ft,512)),[[p,!i.isMonitoring]]),m((d(),h("svg",null,Vt,512)),[[p,i.isMonitoring]])]),u("button",{type:"button",class:"track-btn track-mute-btn",onClick:e[5]||(e[5]=e=>{t.$emit("update:isMuted",!i.isMuted)}),title:"消音"},[m((d(),h("svg",null,Lt,512)),[[p,!i.isMuted]]),m((d(),h("svg",null,Qt,512)),[[p,i.isMuted]])]),u("button",{type:"button",class:w(["track-btn track-solo-btn",{active:i.isSolo}]),onClick:e[6]||(e[6]=e=>{t.$emit("update:isSolo",!i.isSolo)}),title:"ソロ再生"},"Solo",2)])])),_:1},8,["isSelected"])}]]);const Ht={inject:["socket","trackId"],emits:["track-select"],data:()=>({canvasParams:[],canvases:[]}),created(){this.canvasIdManager=new F(8),this.initRecorder()},methods:{setCanvasRef(t){t&&!this.canvases.includes(t)&&this.canvases.push(t)},createCanvas(t){t.hasOwnProperty("id")?this.canvasIdManager.storeId(t.id):t.id=this.canvasIdManager.generateId(),this.canvasParams.push(t)},createCanvasByUser(t){this.createCanvas(c(r({},t),{send:!0}))},removeCanvas(t){this.canvases=[];const e=this.canvasParams.findIndex((e=>e.id===t));this.canvasParams.splice(e,1),this.canvasIdManager.removeId(t)},removeCanvasByUser(t,e=!0){e&&!window.confirm("選択されているキャンバスを削除しますか？")||(this.removeCanvas(t),this.socket.connected&&this.socket.send({type:"removeCanvas",trackId:this.trackId,canvasId:t}))},splitCanvas({canvasId:t,former:e,latter:i}){this.removeCanvasByUser(t,!1),this.createCanvasByUser(e),this.createCanvasByUser(i)},startRecording(){this.recorder.start()},stopRecording(){this.recorder.stop()},getCurrentCanvas(t){return this.canvases.find((e=>e.startPoint<=t&&e.endPoint>=t))},play(){const t=()=>{var e;const i=this.$store.state.pointer_x,s=this.getCurrentCanvas(i);s&&s!==this.currentCanvas&&(null==(e=this.currentCanvas)||e.pause(),this.currentCanvas=s,this.currentCanvas.play(i,(()=>this.currentCanvas=null))),this.playId=requestAnimationFrame(t)};this.playId=requestAnimationFrame(t)},pause(){var t;cancelAnimationFrame(this.playId),null==(t=this.currentCanvas)||t.pause(),this.currentCanvas=null},getDownloadData(t,e){return this.canvases.map((i=>i.getDownloadData(t,e)))},getUploadData(){return this.canvases.map((t=>t.getUploadData()))}}},Wt={render(){return P("canvas",{class:"draft-canvas",width:1e3,height:120,style:this.styles,ref:"canvas"},[])},data:()=>({styles:{display:"none",left:"0px"}}),created(){this.drawPoint=0},mounted(){this.ctx=this.canvas.getContext("2d"),this.initCtxStyle()},computed:{canvas(){return this.$refs.canvas}},methods:{show(t){this.styles.left=t+"px",this.canvas.width=1e3,this.initCtxStyle(),this.drawPoint=0,delete this.styles.display},hide(){this.styles.display="none"},resize(){const t=document.createElement("canvas"),e=t.getContext("2d");t.width=this.canvas.width,t.height=this.canvas.height,e.drawImage(this.canvas,0,0,this.canvas.width,this.canvas.height),this.canvas.width+=1e3,this.initCtxStyle(),this.ctx.drawImage(t,0,0,t.width,t.height)}}};var Xt={name:"AudioDraftCanvas",mixins:[Wt],props:["sourceNode"],created(){this.analyserNode=this.sourceNode.context.createAnalyser(),this.analyserNode.fftSize=1024,this.sourceNode.connect(this.analyserNode),this.dataArray=new Float32Array(this.analyserNode.fftSize)},unmounted(){this.sourceNode.disconnect(this.analyserNode)},computed:{slice_width(){return this.$store.getters.animation_width/this.dataArray.length}},methods:{initCtxStyle(){this.ctx.fillStyle="#78328c",this.ctx.lineWidth=2,this.ctx.strokeStyle="#000"},draw(){this.drawPoint>=this.canvas.width&&this.resize(),this.analyserNode.getFloatTimeDomainData(this.dataArray),this.ctx.fillRect(this.drawPoint,0,this.$store.getters.animation_width,this.canvas.height),this.ctx.beginPath();for(let t=0;t<this.dataArray.length;t++){let e=(this.dataArray[t]+1)*this.canvas.height/2;0===t?this.ctx.moveTo(this.drawPoint,e):this.ctx.lineTo(this.drawPoint,e),this.drawPoint+=this.slice_width}this.ctx.stroke()}}};const Yt={render(){return[P("canvas",{class:"data-canvas",tabindex:-1,width:this._width,height:120,style:this.styles,onKeydown:t=>{t.stopPropagation(),"Backspace"===t.key&&this.$emit("canvas-remove")},onContextmenu:t=>this.$refs.menu.show(t),onTouchstart:t=>this.$refs.menu.show(t),ref:"canvas"},[]),P(x("ContextMenu"),{ref:"menu"},{default:()=>[P("li",{onClick:t=>{t.stopPropagation(),this.split()}},["分割"]),P("li",{onClick:t=>{t.stopPropagation(),this.downloadFile()}},["ダウンロード"]),P("li",{onClick:t=>{t.stopPropagation(),this.$emit("canvas-remove")}},["削除"])]})]},props:{canvasData:{type:Object,required:!0}},inject:["socket","trackId"],emits:["track-select","canvas-split","canvas-remove"],data:()=>({styles:{left:"0px"},_width:0,isSelected:!1}),async created(){this.id=this.canvasData.id,this.initDiminished(this.canvasData.diminished),this.socket.connected&&this.canvasData.send&&this.socket.send({type:"addCanvas",trackId:this.trackId,canvasData:await this.getUploadData()})},async mounted(){this.ctx=this.canvas.getContext("2d"),this.x=this.canvasData.startTime*this.$store.getters.second_width,this.canvas.onpointerover=t=>{this.decideCursor(t.offsetX),this.canvas.onpointermove=t=>this.decideCursor(t.offsetX)},this.canvas.ontouchmove=t=>{t.preventDefault(),t.stopPropagation()},this.canvas.onpointerdown=t=>{t.stopPropagation(),this.canvas.focus(),this.$emit("track-select",t.shiftKey);const e=t.offsetX;if(e<=30)this.canvas.onpointermove=t=>{this.decideCursor(t.offsetX),this.resizeLeft(e,t.offsetX)};else if(this.width-e<=30){let t=e;this.canvas.onpointermove=e=>{this.decideCursor(e.offsetX),this.resizeRight(t,e.offsetX),t=e.offsetX}}else this.styles.cursor="grabbing",this.canvas.onpointermove=t=>this.move(e,t.offsetX)},this.canvas.ontouchend=t=>{t.preventDefault(),t.stopPropagation()},this.canvas.onpointerup=t=>{t.preventDefault(),t.stopPropagation(),this.decideCursor(t.offsetX),this.canvas.onpointermove=t=>this.decideCursor(t.offsetX)},this.canvas.onpointerout=t=>{t.preventDefault(),t.stopPropagation(),delete this.styles.cursor,this.canvas.onpointermove=null},this.canvas.onclick=t=>{t.preventDefault(),t.stopPropagation()}},unmounted(){URL.revokeObjectURL(this.canvasData.url)},computed:{bpm(){return this.$store.state.bpm},beat_width(){return this.$store.state.beat_width},canvas(){return this.$refs.canvas},x:{get(){return this.styles.left.slice(0,-2)-0},set(t){t<0&&(t=0),this.styles.left=t+"px"}},width:{get(){return this._width},set(t){this._width=Math.round(t)}},initStartPoint(){return this.x-this.diminished.left},initEndPoint(){return this.x+this.width+this.diminished.right},startPoint(){return this.x},endPoint(){return this.x+this.width},initStartTime(){return this.initStartPoint/this.$store.getters.second_width},initEndTime(){return this.initEndPoint/this.$store.getters.second_width},startTime(){return this.startPoint/this.$store.getters.second_width},endTime(){return this.endPoint/this.$store.getters.second_width},initDuration(){return(this.diminished.left+this.width+this.diminished.right)/this.$store.getters.second_width},duration(){return this.width/this.$store.getters.second_width}},watch:{bpm(t,e){this.zoom(t,e)},beat_width(t,e){this.zoom(t,e)},width(){this.$nextTick((function(){this.draw()}))}},methods:{play(t,e){},pause(){},draw(){},downloadFile(){},initDiminished(t={leftTime:0,rightTime:0}){this.diminished={left:t.leftTime*this.$store.getters.second_width,right:t.rightTime*this.$store.getters.second_width,getData(){return{leftTime:this.leftTime,rightTime:this.rightTime}}},Object.defineProperties(this.diminished,{leftTime:{get:()=>this.diminished.left/this.$store.getters.second_width},rightTime:{get:()=>this.diminished.right/this.$store.getters.second_width}})},decideCursor(t){t<=30?this.styles.cursor=0===this.diminished.left?"e-resize":"ew-resize":this.width-t<=30?this.styles.cursor=0===this.diminished.right?"w-resize":"ew-resize":this.styles.cursor="grab"},initWidth(t){var e,i;const s=(null==(e=this.canvasData.diminished)?void 0:e.leftTime)||0,a=(null==(i=this.canvasData.diminished)?void 0:i.rightTime)||0;this.width=(t-s-a)*this.$store.getters.second_width,this.endPoint>this.$store.getters.ruler_width&&this.$store.commit("project_duration",this.canvasData.startTime+t)},getTime(t){return(t-this.initStartPoint)/this.$store.getters.second_width},move(t,e){this.x+=e-t},resizeLeft(t,e){e<t?this.lengthenLeft(t,e):this.shortenLeft(t,e)},lengthenLeft(t,e){let i=Math.floor(t-e);this.diminished.left<i&&(i=this.diminished.left),this.x-=i,this.width+=i,this.diminished.left-=i},shortenLeft(t,e){let i=Math.floor(e-t);this.width-i<60&&(i=this.width-60),this.x+=i,this.width-=i,this.diminished.left+=i},resizeRight(t,e){t<e?this.lengthenRight(t,e):this.shortenRight(t,e)},lengthenRight(t,e){let i=Math.floor(e-t);this.diminished.right<i&&(i=this.diminished.right),this.width+=i,this.diminished.right-=i},shortenRight(t,e){let i=Math.floor(t-e);this.width-i<60&&(i=this.width-60),this.width-=i,this.diminished.right+=i},zoom(t,e){const i=t/e;this.x*=i,this.width*=i,this.diminished.left*=i,this.diminished.right*=i},async getDownloadData(t,e){return await fetch(this.canvasData.url).then((t=>t.blob())).then((i=>t.file(this.id+e,i))).catch(console.error),{id:this.id,startTime:this.startTime,diminished:this.diminished.getData()}},async getUploadData(){const t=await fetch(this.canvasData.url).then((t=>t.blob())).then((t=>new Promise((e=>{const i=new FileReader;i.onload=()=>e(i.result),i.readAsDataURL(t)})))).catch(console.error);return{id:this.id,startTime:this.startTime,diminished:this.diminished.getData(),url:t}}}};class Gt{getDrawData(t,e,i,s){const a=Math.floor(t.sampleRate*e),n=Math.floor(t.sampleRate*i),o=[];for(let r=0;r<t.numberOfChannels;r++)o[r]=this.getPeaks(t.getChannelData(r),a,n,s);return o}getPeaks(t,e,i,s=4500){let a=Math.floor((i-e)/s);if(a<3)return t.slice(e,i);const n=[];for(let o=e;o<i;o+=a){const e=this.getPeak(t,o,o+a);n.push(e[0],e[1])}return n}getPeak(t,e,i){let s=t[e],a=s;for(let n=e+1;n<i;n++){const e=t[n];e>s&&(s=e),e<a&&(a=e)}return[s,a]}}class Jt{initCtxStyle(t){t.fillStyle="#78328c",t.lineWidth=2,t.strokeStyle="#000"}draw(t,e,i){this.initCtxStyle(e),e.fillRect(0,0,t.width,t.height),this.drawData(t,e,i)}drawData(t,e,i){i.forEach((i=>{const s=t.width/i.length;let a=0;e.beginPath();for(let n=0;n<i.length;n++){const o=(i[n]+1)*t.height/2;0===n?e.moveTo(a,o):e.lineTo(a,o),a+=s}e.stroke()}))}}var qt=z({name:"AudioTrack",components:{AudioTrackLabel:zt,AudioCanvasContainer:z({name:"AudioCanvasContainer",components:{AudioDraftCanvas:Xt,AudioCanvas:{name:"AudioCanvas",mixins:[Yt],props:{nextNode:Object},async mounted(){this.audioCtx=this.nextNode.context,this.audioBuffer=await gt(this.audioCtx,this.canvasData.url),this.player=new vt(this.audioBuffer,this.nextNode),this.drawer=new Jt,this.drawdataprocessor=new Gt,this.initWidth(this.audioBuffer.duration)},methods:{play(t,e){this.player.play(this.getTime(t),this.getTime(this.endPoint),e)},pause(){this.player.pause()},draw(){this.drawer.draw(this.canvas,this.ctx,this.drawdataprocessor.getDrawData(this.audioBuffer,this.getTime(this.startPoint),this.getTime(this.endPoint)))},split(){const t=this.$store.state.pointer_x;if(this.startPoint<t&&t<this.endPoint){const e=this.getTime(t),i={startTime:this.startTime,diminished:{leftTime:this.diminished.leftTime,rightTime:0},url:ft.AudioBuffer2WavFile(this.audioBuffer,0,e)},s={startTime:this.startTime+e,diminished:{leftTime:0,rightTime:this.diminished.rightTime},url:ft.AudioBuffer2WavFile(this.audioBuffer,e,this.initDuration)};this.$emit("canvas-split",{canvasId:this.id,former:i,latter:s})}},downloadFile(){const t=this.duration*this.audioCtx.sampleRate,e=new OfflineAudioContext(2,t,this.audioCtx.sampleRate),i=e.createBufferSource();i.buffer=this.audioBuffer,i.connect(e.destination),i.start(0,this.diminished.leftTime,this.duration),e.startRendering().then((t=>{const e=ft.AudioBuffer2WavFile(t),i=document.createElement("a");i.href=e,i.download="audio.wav",i.click()})).catch(console.error)},createOfflineSource(t,e,i,s){if(i>this.endTime)return;const a=t.createBufferSource();let n,o,r;a.buffer=this.audioBuffer,a.connect(e),i<this.startTime?(n=this.startTime-i,o=this.diminished.leftTime,r=s<this.endTime?s-this.startTime:this.duration):(n=0,o=i-this.initStartTime,r=s<this.endTime?s-i:this.endTime-i),a.start(n,o,r)}}}},mixins:[Ht],props:{sourceNode:Object,nextNode:Object},methods:{initRecorder(){let t,e;this.recorder=new kt(this.sourceNode),this.recorder.onstart=()=>{t=this.$store.state.pointer_x,this.$refs.draftCanvas.show(t);let i=()=>{this.$refs.draftCanvas.draw(),e=requestAnimationFrame(i)};e=requestAnimationFrame(i)},this.recorder.onstop=i=>{cancelAnimationFrame(e),this.createCanvasByUser({startTime:t/this.$store.getters.second_width,url:i}),this.$refs.draftCanvas.hide()}},createOffline(t,e,i,s){this.canvases.forEach((a=>a.createOfflineSource(t,e,i,s)))}}},[["render",function(t,e,i,s,a,n){const o=x("AudioDraftCanvas"),r=x("AudioCanvas");return d(),h("div",{class:"canvas-container",onPointerdown:e[1]||(e[1]=e=>t.$emit("track-select",e.shiftKey))},[D(o,{sourceNode:i.sourceNode,ref:"draftCanvas"},null,8,["sourceNode"]),(d(!0),h(g,null,k(t.canvasParams,(s=>(d(),T(r,{key:s.id,canvasData:s,nextNode:i.nextNode,ref:t.setCanvasRef,onCanvasSplit:t.splitCanvas,onTrackSelect:e[0]||(e[0]=e=>t.$emit("track-select",e)),onCanvasRemove:e=>t.removeCanvasByUser(s.id)},null,8,["canvasData","nextNode","onCanvasSplit","onCanvasRemove"])))),128))],32)}]])},mixins:[Pt],props:{sourceNode:Object},emits:["track-solo"],data(){return{gain:this.trackData.gain||.5,pan:this.trackData.pan||0,isMonitoring:!1,isMuted:!1,isSolo:!0}},created(){const t=this.sourceNode.context;this.gainNode=t.createGain(),this.pannerNode=t.createStereoPanner(),this.muteNode=t.createGain(),this.soloNode=t.createGain(),this.gainNode.connect(this.pannerNode).connect(this.muteNode).connect(this.soloNode).connect(t.destination),this.gainNode.gain.value=this.gain,this.pannerNode.pan.value=this.pan},mounted(){this.isSolo=!1},unmounted(){try{this.sourceNode.disconnect(this.gainNode)}catch(t){}this.soloNode.disconnect()},watch:{gain(t){this.gainNode.gain.value=t},pan(t){this.pannerNode.pan.value=t},isMonitoring(t){if(t)this.sourceNode.connect(this.gainNode);else try{this.sourceNode.disconnect(this.gainNode)}catch(e){}},isMuted(t){this.muteNode.gain.value=t?0:1},isSolo(t){this.$emit("track-solo")}},methods:{setSolo(t){this.soloNode.gain.value=t?1:0},async getDownloadData(t,e){const i=e+"_"+this.name;return{component:this.trackData.component,name:i,gain:this.gain,pan:this.pan,canvases:await Promise.all(this.$refs.container.getDownloadData(t.folder(i),".wav"))}},async getUploadData(){return{id:this.trackData.id,component:this.trackData.component,name:this.name,gain:this.gain,pan:this.pan,canvases:await Promise.all(this.$refs.container.getUploadData())}},createOffline(t,e,i){const s=t.createGain();s.gain.value=this.gain;const a=t.createStereoPanner();a.pan.value=this.pan,s.connect(a),a.connect(t.destination),this.$refs.container.createOffline(t,s,e,i)}}},[["render",function(t,e,i,s,a,n){const o=x("AudioTrackLabel"),r=x("AudioCanvasContainer");return d(),h(g,null,[(d(),T(N,{to:"#label_field"},[D(o,{trackType:this.trackData.component,name:t.name,"onUpdate:name":e[0]||(e[0]=e=>t.name=e),gain:a.gain,"onUpdate:gain":e[1]||(e[1]=t=>a.gain=t),pan:a.pan,"onUpdate:pan":e[2]||(e[2]=t=>a.pan=t),isSelected:t.isSelected,"onUpdate:isSelected":e[3]||(e[3]=e=>t.isSelected=e),isMonitoring:a.isMonitoring,"onUpdate:isMonitoring":e[4]||(e[4]=t=>a.isMonitoring=t),isMuted:a.isMuted,"onUpdate:isMuted":e[5]||(e[5]=t=>a.isMuted=t),isSolo:a.isSolo,"onUpdate:isSolo":e[6]||(e[6]=t=>a.isSolo=t),onTrackSelect:t.select,onTrackRemove:e[7]||(e[7]=e=>t.$emit("track-remove")),ref:"label"},null,8,["trackType","name","gain","pan","isSelected","isMonitoring","isMuted","isSolo","onTrackSelect"])])),(d(),T(N,{to:"#ruler_layer"},[D(r,{sourceNode:i.sourceNode,nextNode:t.gainNode,onTrackSelect:t.select,ref:"container"},null,8,["sourceNode","nextNode","onTrackSelect"])]))],64)}]]);function Kt(t,e){const i=atob(t),s=new Uint8Array(i.length);for(let n=0;n<i.length;n++)s[n]=i.charCodeAt(n);const a=new Blob([s],{type:e});return URL.createObjectURL(a)}var Zt=z({name:"VideoTrack",components:{VideoTrackLabel:z({name:"VideoTrackLabel",components:{TrackLabel:jt},props:{trackType:String,name:String,isSelected:Boolean},emits:["update:name","update:isSelected","track-select","track-remove"]},[["render",function(t,e,i,s,a,n){const o=x("InputElement"),r=x("TrackLabel");return d(),T(r,{isSelected:i.isSelected,"onUpdate:isSelected":e[1]||(e[1]=e=>t.$emit("update:isSelected",e)),onTrackSelect:e[2]||(e[2]=e=>t.$emit("track-select",e)),onTrackRemove:e[3]||(e[3]=e=>t.$emit("track-remove")),ref:"container"},{"track-type":B((()=>[A(C(i.trackType.slice(0,-5)),1)])),contents:B((()=>[D(o,{type:"text",size:"8",modelValue:i.name,"onUpdate:modelValue":e[0]||(e[0]=e=>t.$emit("update:name",e))},null,8,["modelValue"])])),_:1},8,["isSelected"])}]]),VideoCanvasContainer:z({name:"VideoCanvasContainer",components:{VideoDraftCanvas:{name:"VideoDraftCanvas",mixins:[Wt],methods:{initCtxStyle(){this.ctx.fillStyle="#328c78"},draw(){this.drawPoint>=this.canvas.width&&this.resize();const t=this.$store.getters.animation_width;this.ctx.fillRect(this.drawPoint,0,t,this.canvas.height),this.drawPoint+=t}}},VideoCanvas:{name:"VideoCanvas",mixins:[Yt],async mounted(){this.dataVideo=document.createElement("video"),this.dataVideo.src=this.canvasData.url,await this.seekSync(this.dataVideo,1008e4),await this.seekSync(this.dataVideo,0),this.sample_width=120*this.dataVideo.videoWidth/this.dataVideo.videoHeight,this.initWidth(this.dataVideo.duration),this.showVideo=document.createElement("video"),this.showVideo.style.position="fixed",this.showVideo.style.top="0",this.showVideo.style.zIndex="10",this.showVideo.style.height="110px",this.showVideo.src=this.canvasData.url,await this.seekSync(this.showVideo,0)},unmounted(){this.showVideo.onpause=null,this.showVideo.pause(),this.showVideo.removeAttribute("src"),this.showVideo.remove()},methods:{async seekSync(t,e){t.currentTime=e,await new Promise((e=>t.onseeked=e)),t.onseeked=null},async play(t,e){document.body.appendChild(this.showVideo),await this.seekSync(this.showVideo,this.getTime(t)),await this.showVideo.play(),this.showVideo.onpause=()=>{e(),document.body.removeChild(this.showVideo),this.showVideo.onpause=null},this.playId=setTimeout((()=>this.showVideo.pause()),1e3*this.duration)},pause(){clearTimeout(this.playId),this.showVideo.pause()},async draw(){const t=this.sample_width/this.$store.getters.second_width;for(let e=0;e<Math.ceil(this.width/this.sample_width);e++)await this.seekSync(this.dataVideo,this.diminished.leftTime+t*e),this.ctx.drawImage(this.dataVideo,this.sample_width*e,0,this.sample_width,120)},async split(){const t=this.$store.state.pointer_x;if(this.startPoint<t&&t<this.endPoint){const e=this.getTime(t),i=await fetch(this.canvasData.url).then((t=>t.blob())).then((t=>new Promise((e=>{const i=new FileReader;i.onload=()=>e(i.result.split(",")[1]),i.readAsDataURL(t)})))).catch(console.error),s=await fetch(`${location.protocol}//${location.host}/split-video`,{method:"POST",body:JSON.stringify({splitTime:e,base64:i})}).then((t=>t.json())),a={startTime:this.startTime,diminished:{leftTime:this.diminished.leftTime,rightTime:0},url:Kt(s.former,"video/webm;codecs=vp9")},n={startTime:this.startTime+e,diminished:{leftTime:0,rightTime:this.diminished.rightTime},url:Kt(s.latter,"video/webm;codecs=vp9")};this.$emit("canvas-split",{canvasId:this.id,former:a,latter:n})}},downloadFile(){const t=document.createElement("a");t.href=this.canvasData.url,t.download="video.mp4",t.click()}}}},mixins:[Ht],props:{videoStream:Object},methods:{initRecorder(){let t,e;this.recorder=new MediaRecorder(this.videoStream,{mimeType:"video/webm;codecs=vp9"});let i=[];this.recorder.onstart=()=>{t=this.$store.state.pointer_x,this.$refs.draftCanvas.show(t);let i=()=>{this.$refs.draftCanvas.draw(),e=requestAnimationFrame(i)};e=requestAnimationFrame(i)},this.recorder.ondataavailable=t=>i.push(t.data),this.recorder.onstop=()=>{cancelAnimationFrame(e);const s=new Blob(i,{type:"video/webm;codecs=vp9"});i=[];const a=URL.createObjectURL(s);this.createCanvasByUser({startTime:t/this.$store.getters.second_width,url:a}),this.$refs.draftCanvas.hide()}}}},[["render",function(t,e,i,s,a,n){const o=x("VideoDraftCanvas"),r=x("VideoCanvas");return d(),h("div",{class:"canvas-container",onPointerdown:e[1]||(e[1]=e=>t.$emit("track-select",e.shiftKey))},[D(o,{ref:"draftCanvas"},null,512),(d(!0),h(g,null,k(t.canvasParams,(i=>(d(),T(r,{key:i.id,canvasData:i,ref:t.setCanvasRef,onCanvasSplit:t.splitCanvas,onTrackSelect:e[0]||(e[0]=e=>t.$emit("track-select",e)),onCanvasRemove:e=>t.removeCanvasByUser(i.id)},null,8,["canvasData","onCanvasSplit","onCanvasRemove"])))),128))],32)}]])},mixins:[Pt],props:{videoStream:Object},methods:{async getDownloadData(t,e){const i=e+"_"+this.name;return{component:this.trackData.component,name:i,canvases:await Promise.all(this.$refs.container.getDownloadData(t.folder(i),".webm"))}},async getUploadData(){return{id:this.trackData.id,component:this.trackData.component,name:this.name,canvases:await Promise.all(this.$refs.container.getUploadData())}}}},[["render",function(t,e,i,s,a,n){const o=x("VideoTrackLabel"),r=x("VideoCanvasContainer");return d(),h(g,null,[(d(),T(N,{to:"#label_field"},[D(o,{trackType:this.trackData.component,name:t.name,"onUpdate:name":e[0]||(e[0]=e=>t.name=e),isSelected:t.isSelected,"onUpdate:isSelected":e[1]||(e[1]=e=>t.isSelected=e),onTrackSelect:t.select,onTrackRemove:e[2]||(e[2]=e=>t.$emit("track-remove")),ref:"label"},null,8,["trackType","name","isSelected","onTrackSelect"])])),(d(),T(N,{to:"#ruler_layer"},[D(r,{videoStream:i.videoStream,onTrackSelect:t.select,ref:"container"},null,8,["videoStream","onTrackSelect"])]))],64)}]]);class te{constructor(t,e,i,s){this.note_number=t,this.velocity=e,this.audioCtx=i,this.nextNode=s}start(t=0,e){setTimeout((()=>{this.sourceNode=this.audioCtx.createOscillator(),this.gainNode=this.audioCtx.createGain(),this.sourceNode.frequency.value=function(t){const e=t-69;return 440*Math.pow(2,e/12)}(this.note_number),this.gainNode.gain.value=this.velocity,this.sourceNode.connect(this.gainNode).connect(this.nextNode),this.sourceNode.start(),this.isPlaying=!0,e&&this.stop(e)}),1e3*t)}stop(t=0){this.isPlaying&&setTimeout((()=>{const t=this.audioCtx.currentTime,e=this.gainNode.gain.value;this.gainNode.gain.setValueAtTime(e,t),this.gainNode.gain.linearRampToValueAtTime(0,t+.01),setTimeout((()=>{this.sourceNode.stop(),this.gainNode.disconnect()}),10),this.isPlaying=!1}),1e3*t)}}class ee{constructor(t){this.midiInput=t,this.noteBuffer=[],this.isRecording=!1}start(){this.onstart();const t=Date.now();this.noteOnFn=e=>{this.noteBuffer.push({number:e.note.number,velocity:e.velocity,when:(Date.now()-t)/1e3})},this.noteOffFn=e=>{const i=this.noteBuffer.find((t=>!t.duration&&t.number===e.note.number));i&&(i.duration=(Date.now()-t)/1e3-i.when)},this.midiInput.addListener("noteon","all",this.noteOnFn),this.midiInput.addListener("noteoff","all",this.noteOffFn),this.isRecording=!0}stop(){if(!this.isRecording)return;this.midiInput.removeListener("noteon","all",this.noteOnFn),this.midiInput.removeListener("noteoff","all",this.noteOffFn),this.isRecording=!1;const t=JSON.stringify(this.noteBuffer);this.noteBuffer=[];const e=new Blob([t],{type:"application/json"}),i=URL.createObjectURL(e);this.onstop(i)}}const ie={name:"Editor",components:{Count:bt,Rhythm:Ct,Bpm:xt,Resizer:St,Ruler:Bt,Pointer:It,AudioTrack:qt,VideoTrack:Zt,MidiTrack:z({name:"MidiTrack",components:{AudioTrackLabel:zt,MidiCanvasContainer:z({name:"MidiCanvasContainer",components:{MidiDraftCanvas:{name:"MidiDraftCanvas",mixins:[Wt],methods:{initCtxStyle(){this.ctx.fillStyle="#8c7832"},draw(){this.drawPoint>=this.canvas.width&&this.resize();const t=this.$store.getters.animation_width;this.ctx.fillRect(this.drawPoint,0,t,this.canvas.height),this.drawPoint+=t}}},MidiCanvas:{name:"MidiCanvas",mixins:[Yt],props:{audioCtx:Object,nextNode:Object},async mounted(){this.midiDataArray=await fetch(this.canvasData.url).then((t=>t.text())).then((t=>JSON.parse(t)));const t=this.midiDataArray.reduce(((t,e)=>Math.max(t,e.when+e.duration)),0);this.initWidth(t)},methods:{play(t,e){const i=t/this.$store.getters.second_width;this.sourceNodeArray=this.midiDataArray.map((t=>{if(t.when+this.startTime<i)return;const e=new te(t.number,t.velocity,this.audioCtx,this.nextNode);return e.start(t.when,t.duration),e}))},pause(){this.sourceNodeArray.forEach((t=>t&&t.stop()))},draw(){this.ctx.fillStyle="green",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height);const t=this.midiDataArray.reduce(((t,e)=>Math.max(t,e.number)),0),e=this.midiDataArray.reduce(((t,e)=>Math.min(t,e.number)),200),i=this.canvas.height/(t-e+1);this.midiDataArray.forEach((e=>{const s=e.when*this.$store.getters.second_width,a=(t-e.number)*i,n=e.duration*this.$store.getters.second_width;this.ctx.fillStyle="#ffffff",this.ctx.fillRect(s,a,n,i)}))},split(){},downloadFile(){},createOfflineSource(t,e,i,s){if(i>this.endTime)return;const a=t.createBufferSource();let n,o,r;a.buffer=this.audioBuffer,a.connect(e),i<this.startTime?(n=this.startTime-i,o=this.diminished.leftTime,r=s<this.endTime?s-this.startTime:this.duration):(n=0,o=i-this.initStartTime,r=s<this.endTime?s-i:this.endTime-i),a.start(n,o,r)}}}},mixins:[Ht],props:{audioCtx:Object,nextNode:Object,midiInput:Object},methods:{initRecorder(){let t,e;this.recorder=new ee(this.midiInput),this.recorder.onstart=()=>{t=this.$store.state.pointer_x,console.log(t),this.$refs.draftCanvas.show(t);let i=()=>{this.$refs.draftCanvas.draw(),e=requestAnimationFrame(i)};e=requestAnimationFrame(i)},this.recorder.onstop=i=>{cancelAnimationFrame(e),this.createCanvasByUser({startTime:t/this.$store.getters.second_width,url:i}),this.$refs.draftCanvas.hide()}},createOffline(t,e,i,s){this.canvases.forEach((a=>a.createOfflineSource(t,e,i,s)))}}},[["render",function(t,e,i,s,a,n){const o=x("MidiDraftCanvas"),r=x("MidiCanvas");return d(),h("div",{class:"canvas-container",onPointerdown:e[1]||(e[1]=e=>t.$emit("track-select",e.shiftKey))},[D(o,{ref:"draftCanvas"},null,512),(d(!0),h(g,null,k(t.canvasParams,(s=>(d(),T(r,{key:s.id,canvasData:s,audioCtx:i.audioCtx,nextNode:i.nextNode,ref:t.setCanvasRef,onCanvasSplit:t.splitCanvas,onTrackSelect:e[0]||(e[0]=e=>t.$emit("track-select",e)),onCanvasRemove:e=>t.removeCanvasByUser(s.id)},null,8,["canvasData","audioCtx","nextNode","onCanvasSplit","onCanvasRemove"])))),128))],32)}]])},mixins:[Pt],props:{audioCtx:Object,midiInput:Object},emits:["track-solo"],data(){return{gain:this.trackData.gain||.5,pan:this.trackData.pan||0,isMonitoring:!1,isMuted:!1,isSolo:!0}},created(){this.gainNode=this.audioCtx.createGain(),this.gainNode.gain.value=.5,this.pannerNode=this.audioCtx.createStereoPanner(),this.muteNode=this.audioCtx.createGain(),this.soloNode=this.audioCtx.createGain(),this.gainNode.connect(this.pannerNode).connect(this.muteNode).connect(this.soloNode).connect(this.audioCtx.destination),this.gainNode.gain.value=this.gain,this.pannerNode.pan.value=this.pan;const t=[];this.midiInput.addListener("noteon","all",(e=>{if(this.isSelected){const i=new te(e.note.number,e.velocity,this.audioCtx,this.gainNode);i.start(),t.push(i)}})),this.midiInput.addListener("noteoff","all",(e=>{t.filter((t=>t.note_number===e.note.number)).forEach((e=>{e.stop(),t.splice(t.indexOf(e),1)}))}))},mounted(){this.isSolo=!1},unmounted(){this.soloNode.disconnect()},watch:{gain(t){this.gainNode.gain.value=t},pan(t){this.pannerNode.pan.value=t},isMuted(t){this.muteNode.gain.value=t?0:1},isSolo(t){this.$emit("track-solo")}},methods:{setSolo(t){this.soloNode.gain.value=t?1:0},async getDownloadData(t,e){const i=e+"_"+this.name;return{component:this.trackData.component,name:i,gain:this.gain,pan:this.pan,canvases:await Promise.all(this.$refs.container.getDownloadData(t.folder(i),".wav"))}},async getUploadData(){return{id:this.trackData.id,component:this.trackData.component,name:this.name,gain:this.gain,pan:this.pan,canvases:await Promise.all(this.$refs.container.getUploadData())}},createOffline(t,e,i){const s=t.createGain();s.gain.value=this.gain;const a=t.createStereoPanner();a.pan.value=this.pan,s.connect(a),a.connect(t.destination),this.$refs.container.createOffline(t,s,e,i)}}},[["render",function(t,e,i,s,a,n){const o=x("AudioTrackLabel"),r=x("MidiCanvasContainer");return d(),h(g,null,[(d(),T(N,{to:"#label_field"},[D(o,{trackType:this.trackData.component,name:t.name,"onUpdate:name":e[0]||(e[0]=e=>t.name=e),gain:a.gain,"onUpdate:gain":e[1]||(e[1]=t=>a.gain=t),pan:a.pan,"onUpdate:pan":e[2]||(e[2]=t=>a.pan=t),isSelected:t.isSelected,"onUpdate:isSelected":e[3]||(e[3]=e=>t.isSelected=e),isMonitoring:a.isMonitoring,"onUpdate:isMonitoring":e[4]||(e[4]=t=>a.isMonitoring=t),isMuted:a.isMuted,"onUpdate:isMuted":e[5]||(e[5]=t=>a.isMuted=t),isSolo:a.isSolo,"onUpdate:isSolo":e[6]||(e[6]=t=>a.isSolo=t),onTrackSelect:t.select,onTrackRemove:e[7]||(e[7]=e=>t.$emit("track-remove")),ref:"label"},null,8,["trackType","name","gain","pan","isSelected","isMonitoring","isMuted","isSolo","onTrackSelect"])])),(d(),T(N,{to:"#ruler_layer"},[D(r,{audioCtx:i.audioCtx,nextNode:t.gainNode,midiInput:i.midiInput,onTrackSelect:t.select,ref:"container"},null,8,["audioCtx","nextNode","midiInput","onTrackSelect"])]))],64)}]])},emits:["add-track"],inject:["socket"],data:()=>({trackParams:[],tracks:[],audioCtx:null,sourceNode:null,videoStream:null,midiInput:null,state:null}),async created(){this.trackIdManager=new F(8),this.audioCtx=new(window.AudioContext||window.webkitAudioContext),this.audioCtx.onstatechange=()=>{"running"!==this.audioCtx.state&&this.audioCtx.resume()},await this.audioCtx.audioWorklet.addModule("./RecorderProcessor.js")},mounted(){document.ondragover=t=>{t.stopPropagation(),t.preventDefault()},document.ondrop=async t=>{var e,i;t.stopPropagation(),t.preventDefault();const s=t.dataTransfer.items;if(1===s.length){const t=s[0],a=(null==(e=t.getAsEntry)?void 0:e.call(t))||(null==(i=t.webkitGetAsEntry)?void 0:i.call(t));if(a.isFile)a.file((async t=>{if(this.isAudioFile(t))this.loadAudioFile(t);else if(this.isVideoFile(t))this.loadVideoFile(t);else if("application/zip"===t.type){const e=await this.readProjectZip(t);this.loadProject(e)}}),console.error);else if(a.isDirectory){const t=await this.readProjectDirectory(a);this.loadProject(t)}}},document.onkeydown=t=>{switch(t.key){case"r":"recording"!==this.state&&this.startRecording();break;case"Backspace":"recording"!==this.state&&this.removeSelectedTracks();break;case" ":switch(t.preventDefault(),this.state){case"preparing":case"recording":this.stopRecording();break;case"playing":this.pause();break;default:this.play()}}}},methods:{async getAudioStream(){var t,e;(null==(e=null==(t=this.sourceNode)?void 0:t.mediaStream)?void 0:e.active)||await navigator.mediaDevices.getUserMedia({video:!1,audio:{autoGainControl:!1,echoCancellation:!1,noiseSuppression:!1,sampleRate:44100}}).then((t=>{const e=this.audioCtx.createMediaStreamSource(t);this.sourceNode=this.audioCtx.createChannelMerger(1),e.connect(this.sourceNode,0,0)})).catch((t=>{throw alert("マイク入力を取得できません。"),new Error}))},async getVideoStream(){var t;(null==(t=this.videoStream)?void 0:t.active)||await navigator.mediaDevices.getUserMedia({video:!0,audio:!1}).then((t=>this.videoStream=t)).catch((t=>{throw alert("カメラを取得できません。"),new Error}))},async getMidiInput(){this.midiInput||await new Promise(((t,e)=>$.enable((i=>{i&&e("web midi error"),t($.inputs[0])})))).then((t=>this.midiInput=t)).catch((t=>{throw alert("MIDI入力を取得できません。"),new Error}))},setTrackRef(t){t&&!this.tracks.includes(t)&&this.tracks.push(t)},async addTrack(t={}){try{if("AudioTrack"===t.component)await this.getAudioStream();else if("VideoTrack"===t.component){if(!MediaRecorder.isTypeSupported("video/webm;codecs=vp9"))return void alert("このブラウザではwebm形式がサポートされていないので録画ができません。");await this.getVideoStream()}else{if("MidiTrack"!==t.component)return;await this.getMidiInput()}}catch(e){return}t.hasOwnProperty("id")?this.trackIdManager.storeId(t.id):t.id=this.trackIdManager.generateId(),this.trackParams.push(t)},async addTrackByUser(t={}){await this.addTrack(c(r({},t),{send:!0}))},removeTrack(t){this.tracks=[];const e=this.trackParams.findIndex((e=>e.id===t));this.trackParams.splice(e,1),this.trackIdManager.removeId(t)},removeTrackByUser(t){window.confirm("選択されているトラックを削除しますか？")&&(this.removeTrack(t),this.socket.connected&&this.socket.send({type:"removeTrack",trackId:t}))},removeSelectedTracks(){this.tracks.filter((t=>t.isSelected)).forEach((t=>this.removeTrackByUser(t.id)))},makeTracksSolo(){this.tracks.every((t=>!t.isSolo))?this.tracks.forEach((t=>{var e;return null==(e=t.setSolo)?void 0:e.call(t,!0)})):this.tracks.forEach((t=>{var e;return null==(e=t.setSolo)?void 0:e.call(t,t.isSolo)}))},onPointerMove({layerX:t,x:e}){const i=this.$refs.pointer_layer;"recording"===this.state&&t-i.scrollLeft>i.offsetWidth&&(i.scrollLeft+=i.offsetWidth),e>=this.$store.getters.ruler_width&&this.$store.commit("addProjectDuration",30)},shiftPointer(t){"recording"===this.state||t.offsetY>30||(this.$refs.pointer.layerX=t.clientX-200+this.$refs.pointer_layer.scrollLeft,this.$refs.count.setNumberFromPointerX(this.$refs.pointer.x),"playing"===this.state&&(this.pause(),this.play()))},getTouchesDiff(t){const e=t[0].clientX,i=t[0].clientY,s=t[1].clientX,a=t[1].clientY;return Math.sqrt(Math.pow(s-e,2),Math.pow(a-i))},startTouches(t){"recording"===state&&2!==t.touches.length||(this.oldTouchesDiff=this.getTouchesDiff(t.touches))},zoomWithTouches(t){if("recording"===state||2!==t.touches.length)return;t.preventDefault();const e=this.getTouchesDiff(t.touches),i=Math.round(this.$store.state.beat_width*e/this.oldTouchesDiff);10<i&&i<100&&(this.$refs.resizer.value=i,this.$store.commit("beat_width",i),this.oldTouchesDiff=e)},async startRecording(){this.selectedTracks=this.tracks.filter((t=>t.isSelected));const t=this.tracks.filter((t=>!t.isSelected));if(this.selectedTracks.length){try{this.selectedTracks.filter((t=>"AudioTrack"===t.component)).length&&await this.getAudioStream(),this.selectedTracks.filter((t=>"VideoTrack"===t.component)).length&&await this.getVideoStream()}catch(e){return}"playing"===this.state&&this.pause(),this.$refs.pointer.prepareRecording(),this.$refs.count.setNumberFromPointerX(this.$refs.pointer.x),this.$refs.count.start(),this.$refs.pointer.start(),t.forEach((t=>t.play())),this.state="preparing",setTimeout((()=>{"preparing"===this.state&&(this.state="recording",this.$refs.bpm.disabled=!0,this.$refs.resizer.disabled=!0,this.selectedTracks.forEach((t=>t.startRecording())))}),this.$store.getters.bar_width/this.$store.getters.second_width*1e3)}},stopRecording(){"recording"===this.state&&(this.$refs.bpm.disabled=!1,this.$refs.resizer.disabled=!1,this.selectedTracks.forEach((t=>t.stopRecording()))),this.pause()},async play(){this.tracks.forEach((t=>t.play()));const t=this.$store.getters.scale_width,e=this.$refs.pointer.x,i=(e>0?t-e%t:-e%t)/this.$store.getters.second_width;this.$refs.count.start(i),this.$refs.pointer.start(),this.state="playing"},pause(){this.tracks.forEach((t=>t.pause())),this.$refs.count.stop(),this.$refs.pointer.stop(),this.state=null},isAudioFile:t=>"audio"===t.type.split("/")[0],async loadAudioFile(t){await this.addTrackByUser({component:"AudioTrack",canvases:[{startTime:0,url:URL.createObjectURL(t)}]})},isVideoFile:t=>"video"===t.type.split("/")[0],async loadVideoFile(t){await this.addTrackByUser({component:"VideoTrack",canvases:[{startTime:0,url:URL.createObjectURL(t)}]})},download(t,e){const i=document.createElement("a");i.href=t,i.download=e,i.click()},downloadProject(){this.getDownloadData().then((t=>this.download(URL.createObjectURL(t),"project.zip")))},getProjectConfig(){const t=this.$store.state;return{rhythm:t.rhythm,bpm:t.bpm,beat_width:t.beat_width,project_duration:t.project_duration}},setProjectConfig(t){this.$refs.rhythm.init(t.rhythm),this.$refs.bpm.init(t.bpm),this.$refs.resizer.init(t.beat_width),this.$store.commit("project_duration",Number(t.project_duration))},async getDownloadData(){const t=new j,e=JSON.stringify(c(r({},this.getProjectConfig()),{tracks:await Promise.all(this.tracks.map(((e,i)=>e.getDownloadData(t,i))))}));return t.file("config.json",new Blob([e],{type:"application/json"})),t.generateAsync({type:"blob"})},async readProjectZip(t){const e={},i=[],s=await j.loadAsync(t);return s.forEach(((t,a)=>{if("config.json"===a.name)i.push(s.file(a.name).async("string").then((t=>e["config.json"]=JSON.parse(t))));else if(!a.dir){let t=e;const n=a.name.split("/"),o=n.pop();n.forEach((e=>{t[e]||(t[e]={}),t=t[e]})),i.push(s.file(a.name).async("blob").then((e=>t[o]=URL.createObjectURL(e))))}})),await Promise.all(i),e},async readProjectDirectory(t){const e={};return await new Promise((i=>function t(e,i,s){e.isFile?e.file((t=>{if("config.json"===t.name){const e=new FileReader;e.onload=t=>{i["config.json"]=JSON.parse(e.result),s()},e.readAsText(t)}else i[t.name]=URL.createObjectURL(t)}),console.error):e.isDirectory&&(i[e.name]={},e.createReader().readEntries((a=>a.forEach((a=>t(a,i[e.name],s)))),console.error))}(t,e,i))),Object.values(e)[0]},loadProject(t){this.trackIdManager=new F(8),this.trackParams=[],this.$nextTick((async()=>{const e=t["config.json"];this.setProjectConfig(e);for await(let i of e.tracks){let e;"AudioTrack"===i.component?e=".wav":"VideoTrack"===i.component&&(e=".webm"),i.canvases.forEach((s=>{s.url=t[i.name][s.id+e]})),await this.addTrackByUser(i)}}))},async getUploadData(){return c(r({},this.getProjectConfig()),{tracks:await Promise.all(this.tracks.map((t=>t.getUploadData())))})},loadSharedProject(t){this.trackIdManager=new F(8),this.trackParams=[],this.$nextTick((async()=>{this.setProjectConfig(t);for await(let e of t.tracks)await this.addTrack(e);console.info("プロジェクトに参加しました。")}))},getTimeFromBarAndBeat(t){const e=this.$store.state;return(t.bar*e.rhythm[0]+t.beat-1)*this.$store.getters.scale_width/this.$store.getters.second_width},writeProjectAudio(t){const e=this.getTimeFromBarAndBeat(t.start),i=this.getTimeFromBarAndBeat(t.stop),s=(i-e)*this.audioCtx.sampleRate,a=new(window.OfflineAudioContext||window.webkitOfflineAudioContext)(2,s,this.audioCtx.sampleRate);this.tracks.forEach((t=>{var s;return null==(s=t.createOffline)?void 0:s.call(t,a,e,i)})),a.startRendering().then((t=>this.download(ft.AudioBuffer2WavFile(t),"project.wav"))).catch(console.error)}}},se={id:"header"},ae=[u("img",{src:"/assets/plus_icon.d7fa19c0.png"},null,-1)];const ne={name:"App",components:{SideMenu:W,VideoContainer:G,Dialog:J,ChooseTrackComponent:st,WriteRange:pt,Editor:z(ie,[["render",function(t,e,i,s,a,n){const o=x("Count"),r=x("Rhythm"),c=x("Bpm"),l=x("Resizer"),f=x("Pointer"),v=x("Ruler");return d(),h(g,null,[u("div",se,[D(o,{ref:"count",audioCtx:a.audioCtx},null,8,["audioCtx"]),D(r,{ref:"rhythm"},null,512),m(u("img",{src:"data:image/png;base64,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",class:"play-or-pause",onClick:e[0]||(e[0]=(...t)=>n.play&&n.play(...t))},null,512),[[p,null===a.state]]),m(u("img",{src:"/assets/pause.002d3fec.png",class:"play-or-pause",onClick:e[1]||(e[1]=(...t)=>n.pause&&n.pause(...t))},null,512),[[p,"playing"===a.state]]),u("button",{type:"button",id:"start",onClick:e[2]||(e[2]=t=>"preparing"===a.state||"recording"===a.state?n.stopRecording():n.startRecording())},"R"),D(c,{ref:"bpm"},null,512),D(l,{ref:"resizer"},null,512)]),u("div",{id:"label_field",class:"no-scroll-bar",onScroll:e[4]||(e[4]=e=>t.$refs.ruler_layer.scrollTop=t.$refs.label_field.scrollTop),ref:"label_field"},[u("div",{id:"add_track_btn",title:"トラックを追加",onClick:e[3]||(e[3]=e=>{a.audioCtx.resume(),t.$emit("add-track")})},ae)],544),u("div",{id:"pointer_layer",class:"no-scroll-bar",onClick:e[8]||(e[8]=(...t)=>n.shiftPointer&&n.shiftPointer(...t)),ref:"pointer_layer"},[D(f,{margin:20,onMove:n.onPointerMove,ref:"pointer"},null,8,["onMove"]),u("div",{id:"ruler_layer",class:"no-scroll-bar",onScroll:e[5]||(e[5]=e=>t.$refs.label_field.scrollTop=t.$refs.ruler_layer.scrollTop),onTouchstart:e[6]||(e[6]=(...t)=>n.startTouches&&n.startTouches(...t)),onTouchmove:e[7]||(e[7]=(...t)=>n.zoomWithTouches&&n.zoomWithTouches(...t)),ref:"ruler_layer"},[D(v,{ref:"ruler"},null,512)],544)],512),(d(!0),h(g,null,k(a.trackParams,(t=>(d(),T(M(t.component),{key:t.id,trackData:t,audioCtx:a.audioCtx,sourceNode:a.sourceNode,videoStream:a.videoStream,midiInput:a.midiInput,ref:n.setTrackRef,onTrackSolo:n.makeTracksSolo,onTrackRemove:e=>n.removeTrackByUser(t.id)},null,8,["trackData","audioCtx","sourceNode","videoStream","midiInput","onTrackSolo","onTrackRemove"])))),128))],64)}]])},data:()=>({isShowDialog:!1,dialogType:null,projectId:null}),provide(){return this.socket=new L,{socket:this.socket}},mounted(){window.onpopstate=t=>t.preventDefault(),window.onbeforeunload=t=>{t.preventDefault(),t.returnValue="ページを移動すると全てのデータが失われます。"},window.onorientationchange=this.alertScreenOrientation,window.onload=()=>{this.alertScreenOrientation(),"?id="===location.search.substring(0,4)&&this.startProject(location.search.substring(4))},window.ontouchmove=t=>t.preventDefault(),this.socket.init((async t=>{switch(t.type){case"joinProject":this.socket.send({type:"shareProject",target:t.target,projectData:await this.$refs.editor.getUploadData()});break;case"changeBpm":this.$refs.editor.$refs.bpm.init(t.value);break;case"changeRhythm":this.$refs.editor.$refs.rhythm.init(t.value);break;case"addTrack":this.$refs.editor.addTrack(t.trackData);break;case"removeTrack":this.$refs.editor.removeTrack(t.trackId);break;case"changeTrackName":this.$refs.editor.tracks.find((e=>e.id===t.trackId)).name=t.value;break;case"addCanvas":this.$refs.editor.tracks.find((e=>e.id===t.trackId)).$refs.container.createCanvas(t.canvasData);break;case"removeCanvas":this.$refs.editor.tracks.find((e=>e.id===t.trackId)).$refs.container.removeCanvas(t.canvasId)}}))},methods:{alertScreenOrientation(){var t,e;const i=(null==(e=null==(t=window.screen)?void 0:t.orientaion)?void 0:e.angle)||window.orientation;window.screen.width<550&&0===i&&alert("画面を横向きにしてください。")},showDialog(t){this.isShowDialog=!0,this.dialogType=t},startProject(t){this.projectId="loading",this.socket.connect(),this.socket.onclose=t=>this.projectId=null,this.socket.onerror=t=>this.projectId=null,this.socket.onopen=()=>{this.socket.send({type:"startProject",id:t}),this.socket.onmessage=e=>{switch(e.type){case"startProject":this.projectId=t,console.info("プロジェクトを共有しました。id: "+this.projectId);break;case"shareProject":this.projectId=t,this.$refs.editor.loadSharedProject(e.projectData)}this.socket.setDefault()}}},endProject(){this.socket.close(),this.$refs.videoContainer.room.close()}}},oe={key:0},re=A("プロジェクトを共有"),ce=u("br",null,null,-1),de={key:1},he=u("a",{href:"/docs/",target:"_blank"},"ヘルプ",-1);var le=z(ne,[["render",function(t,e,i,s,a,n){const o=x("VideoContainer"),r=x("SideMenu"),c=x("ChooseTrackComponent"),f=x("WriteRange"),v=x("Dialog"),w=x("Editor");return d(),h(g,null,[D(r,null,{default:B((()=>[u("a",{onClick:e[0]||(e[0]=(...e)=>t.$refs.editor.downloadProject&&t.$refs.editor.downloadProject(...e))},"プロジェクトファイルをダウンロード"),u("a",{onClick:e[1]||(e[1]=t=>n.showDialog("WriteRange"))},"選択範囲を書き出す"),null===a.projectId?(d(),h("a",oe,[re,ce,u("input",{size:"8",onKeydown:e[2]||(e[2]=R(l((t=>n.startProject(t.target.value)),["prevent"]),["enter"]))},null,32)])):"loading"===a.projectId?(d(),h("a",de,"Loading...")):(d(),h(g,{key:2},[u("a",null,"プロジェクトID: "+C(a.projectId),1),u("a",{onClick:e[3]||(e[3]=(...t)=>n.endProject&&n.endProject(...t))},"共有を停止する")],64)),he,"loading"!==a.projectId&&null!==a.projectId?(d(),T(o,{key:3,roomId:a.projectId,ref:"videoContainer"},null,8,["roomId"])):O("",!0)])),_:1}),m(D(v,{onHideDialog:e[7]||(e[7]=t=>a.isShowDialog=!1)},{default:B((()=>["ChooseTrackComponent"===a.dialogType?(d(),T(c,{key:0,onChooseTrackComponent:e[4]||(e[4]=e=>t.$refs.editor.addTrackByUser({component:e})),onHideDialog:e[5]||(e[5]=t=>a.isShowDialog=!1)})):"WriteRange"===a.dialogType?(d(),T(f,{key:1,onWriteProject:t.$refs.editor.writeProjectAudio,onHideDialog:e[6]||(e[6]=t=>a.isShowDialog=!1)},null,8,["onWriteProject"])):O("",!0)])),_:1},512),[[p,a.isShowDialog]]),D(w,{onAddTrack:e[8]||(e[8]=t=>n.showDialog("ChooseTrackComponent")),ref:"editor"},null,512)],64)}]]);var ue=z({name:"ContextMenu",data:()=>({styles:{top:"0px",left:"0px"},isShow:!1}),methods:{show(t){switch(t.type){case"contextmenu":t.preventDefault(),this.styles.top=t.clientY+"px",this.styles.left=t.clientX+"px";break;case"touchstart":if(2!==t.touches.length)return;this.styles.top=(t.touches[0].clientY+t.touches[1].clientY)/2+"px",this.styles.left=(t.touches[0].clientX+t.touches[1].clientX)/2+"px"}this.isShow=!0,setTimeout((()=>this.$refs.domElement.focus()))}}},[["render",function(t,e,i,s,a,n){return m((d(),h("div",{class:"context-menu",tabindex:"-1",style:S(a.styles),onBlur:e[0]||(e[0]=t=>{a.isShow=!1}),onClick:e[1]||(e[1]=l((()=>{}),["stop"])),ref:"domElement"},[u("ul",null,[f(t.$slots,"default")])],36)),[[p,a.isShow]])}]]);const me={name:"InputElement",props:{type:String,size:String,modelValue:String,disabled:{type:Boolean,default:!1}},emits:["update:modelValue"],data(){return{isInputing:!1,value:this.modelValue}},methods:{finishInput(){"text"===this.type&&(this.value=this.value.trim().replace(/\r?\n/g,"")),this.value&&(this.isInputing=!1,this.$emit("update:modelValue",this.value))}}},pe={class:"input-element"},fe=["type"];var ge=z(me,[["render",function(t,e,i,s,a,n){return d(),h("div",pe,[a.isInputing?m((d(),h("input",{key:1,type:i.type,style:S({width:i.size+"rem"}),"onUpdate:modelValue":e[1]||(e[1]=t=>a.value=t),onKeydown:[e[2]||(e[2]=R(l(((...t)=>n.finishInput&&n.finishInput(...t)),["stop"]),["enter"])),e[3]||(e[3]=l((()=>{}),["stop"]))]},null,44,fe)),[[U,a.value]]):(d(),h("p",{key:0,onDblclick:e[0]||(e[0]=t=>{i.disabled||(a.isInputing=!0)})},C(a.value),33))])}]]);const ve=E({state:()=>({rhythm:[4,4],bpm:120,beat_width:20,project_duration:60,pointer_x:0}),getters:{second_width:(t,e)=>t.bpm/60*t.beat_width,animation_width:(t,e)=>e.second_width/60,scale_width:t=>4*t.beat_width/t.rhythm[1],bar_width:(t,e)=>e.scale_width*t.rhythm[0],ruler_width:(t,e)=>t.project_duration*e.second_width},mutations:{rhythm:(t,e)=>t.rhythm=e,bpm:(t,e)=>t.bpm=e,beat_width:(t,e)=>t.beat_width=e,project_duration:(t,e)=>t.project_duration=e,addProjectDuration:(t,e)=>t.project_duration+=e,pointer_x:(t,e)=>t.pointer_x=e}});_(le).component("ContextMenu",ue).component("InputElement",ge).use(ve).mount("#app");

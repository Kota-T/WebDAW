import{o as t,c as e,a as s,w as a,v as i,r as n,b as r,F as o,t as h,d as c,e as l,f as d,g as u,h as A,i as f,T as m,J as p,j as g,k as w,l as v,m as C}from"./vendor.56001c8e.js";const b={name:"SideMenu",data:()=>({isShow:!1})};b.render=function(h,c,l,d,u,A){return t(),e(o,null,[s("img",{id:"menu-btn",src:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAADICAMAAACahl6sAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAACB1BMVEUAAAD////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////T09R8fH1EREUoKCkSEhMrKywNDQ0ODg4ODg5EREV8fH3R0dOysrMnJygTExMbGxsgICAjIyMlJSUlJSUmJiYmJiYmJiYgICAbGxsTExMlJSeysrNBQUIVFRUhISAoKCgsLCwvLy8wMDAxMTExMTEyMjIyMjIyMjIvLy8sLCwoKCghISEVFRVAQEHo6OkkJCUcHBwoKCguLi4xMTEyMjIxMTEuLi4oKCgcHBwjIyTn5+gkJCUeHh4rKyswMDAyMjIyMjIwMDArKyseHh4jIyRAQEEcHBwrKyswMDAyMjIyMjIxMTArKyscHBw/P0Czs7QVFRUwMDAwMDAoKCgVFRWxsbIlJSYgICAuLi4yMjIuLi4gICAkJCXs7O0REREnJycxMTExMTEnJycRERHq6uu2trcXFxcrKysrKysYGBi0tLV+fn8cHBwtLS0tLS0dHR18fH1FRUYgICAvLy8vLy8gICBDQ0QYGBkiIiEwMDAwMDAiIiIVFRdHe1K+AAAAL3RSTlMACSpXibje9vbeuIlXKgobZ9bVZhoESdXUSAQDVlcDOPb2OAqVlQkm/f0mREVXV01fHiUAAAABYktHRAH/Ai3eAAAACXBIWXMAAAsRAAALEQF/ZF+RAAAAB3RJTUUH4AQeFDApGQ2SfQAAA3pJREFUeNrt3fVXmmEYxvFbSgVERUQaRAysZ5u13qx1Wqw3N9fluru7uzv/yGFsFqh7/YH3fri+fwGfw4GX5znXORDFLkWj1ekNqUJFpaUbTeYMC/1HmVnZQrVZc2zjU+Ta84TKczhdYzLcHsEir290hz8gmJQfHIVREBKMKiyK5yguEawKl8Z2lAl2lcdyVAiGVY50VAqWVQx3lAumlQ11lAq2FQ92FIX5QkoKBkEKBeNCA46gYJ3/r8OXzxsScPdDvIJ5nj6HS7Avtxfi5A+x90Ic/CF5PQ6bkKDMKCRHBkhWFGKVAZJNZBFSlEIZckA0ZJYDoiWTHBAdGeWA6CldDoiB0uSApJKQJEAAAQQQQFQKmTR5SlV1TW3d1IRUV1tTXTVt+owJQ2bOmj1nbn1DY1PzvITU3NTYUD9/wcJFiycGWbJ02fIVK1ta29o7Igmpo72ttWXV6jVr162fAGTDxk2dm7ckiDC4rq3btu/YuUsxZPeevfv2R1RR94GDhw4rhRw5euz4iYhKOnnq9JmzyiDnzndeUI0jKrl46fIVRZCr1653R1TUjZu3biuB3Ll7735EVT14+OixAsiTp8861AXpev7ipQLIq9dvIirr7bv3CiAfPn5SG+Tzl68KIN++/1Ab5Oev38n8jkjzGZHmW0ua54g0T3Z5fmtJ8+tXnvOIPCdEac7sEt2iyHOvhStTQAABBBBAAAEEEEAAAQQQQAABBBBAAEkoBAs6LOiwoIsbFnRY0GFBhwUdFnRY0GFBhwUdFnRY0CXJkx0LOizosKBLnjO7wIIOCzpcmQICCCCAAAIIIIAAAggggAACCCCAAALIkLCgw4IOC7q4YUGHBR0WdFjQYUGHBR0WdFjQYUGHBV2SPNmxoMOCDgu65DmzCyzosKDDlSkggACSLJBUORxpZJADkk56OSBG0skBMZFWDoiZNHJAMihFDoiFKFsGh5WIsmSA5EQhmTJAbD1/0J7H3+HocZCdP8TZC8nlD3H1QsjD3eHtc5A7wNuR7+uHkJ83JEj/CnF2FA44qKCEryNcNAhCxXwhpTSkMq6OchpWBU9HJY2okqOjgmJUzs9RRjErDfNilBRTnIoKOTlCBRS/YD4XRsBPo+bz8nB43DRWLqdD7Yo8ey6NK1uOVb2K7KxM+o8sGWaTMT1NTYJUg16n1aTEecF/AHk6eVjcqD8oAAAAJXRFWHRkYXRlOmNyZWF0ZQAyMDE3LTA2LTA3VDE0OjU5OjU3KzA5OjAwXz7h4QAAACV0RVh0ZGF0ZTptb2RpZnkAMjAxNi0wNC0zMFQyMDo0ODo0MSswOTowMN5yVooAAAAASUVORK5CYII=",onClick:c[1]||(c[1]=t=>u.isShow=!u.isShow)}),a(s("div",{id:"side-menu",onClick:c[2]||(c[2]=r((()=>{}),["stop"])),onKeydown:c[3]||(c[3]=r((()=>{}),["stop"]))},[n(h.$slots,"default")],544),[[i,u.isShow]])],64)};const x={name:"Popup"},y={id:"popup"};x.render=function(a,i,o,h,c,l){return t(),e("div",{id:"popup-background",onClick:i[1]||(i[1]=r((()=>{}),["stop"])),onKeydown:i[2]||(i[2]=r((()=>{}),["stop"]))},[s("div",y,[n(a.$slots,"default")])],32)};const k={name:"WriteRange",emits:["hide-popup","write-project"],methods:{writeProject(){const t=this,e=Object.freeze({bar:Number(t.$refs.startBar.value),beat:Number(t.$refs.startBeat.value)}),s=Object.freeze({bar:Number(t.$refs.stopBar.value),beat:Number(t.$refs.stopBeat.value)});this.$emit("write-project",{start:e,stop:s}),this.$emit("hide-popup")},reset(){this.$refs.startBar.value="",this.$refs.startBeat.value="",this.$refs.stopBar.value="",this.$refs.stopBeat.value=""},hide(){this.reset(),this.$emit("hide-popup")}}},D={class:"popup-inner-container"},B=s("tr",null,[s("th"),s("th",null,"小節"),s("th",null,"拍")],-1),I=s("th",null,"start",-1),P={ref:"startBar"},S={ref:"startBeat"},E=s("th",null,"stop",-1),T={ref:"stopBar"},j={ref:"stopBeat"};k.render=function(a,i,n,o,h,c){return t(),e("div",D,[s("table",null,[B,s("tr",null,[I,s("td",null,[s("textarea",P,null,512)]),s("td",null,[s("textarea",S,null,512)])]),s("tr",null,[E,s("td",null,[s("textarea",T,null,512)]),s("td",null,[s("textarea",j,null,512)])])]),s("button",{onClick:i[1]||(i[1]=r(((...t)=>c.writeProject&&c.writeProject(...t)),["stop"]))},"決定"),s("button",{onClick:i[2]||(i[2]=r(((...t)=>c.hide&&c.hide(...t)),["stop"]))},"中止")])};class R{static AudioBuffer2WavFile(t){return R.writeWav(R.AudioBuffer2WavData(t),t.sampleRate)}static AudioBuffer2WavData(t){const e=t.getChannelData(0),s=t.getChannelData(1),a=new Float32Array(2*t.length);for(let i=0;i<t.length;i++)a[2*i]=e[i],a[2*i+1]=s[i];return a}static writeWav(t,e){const s=new ArrayBuffer(44+2*t.length),a=new DataView(s);R.writeWavHead(a,t.length,e),R.writeWavData(a,t);const i=new Blob([a],{type:"audio/wav"});return URL.createObjectURL(i)}static writeWavHead(t,e,s){const a=function(t,e,s){for(let a=0;a<s.length;a++)t.setUint8(e+a,s.charCodeAt(a))};a(t,0,"RIFF"),t.setUint32(4,32+2*e,!0),a(t,8,"WAVE"),a(t,12,"fmt "),t.setUint32(16,16,!0),t.setUint16(20,1,!0),t.setUint16(22,2,!0),t.setUint32(24,s,!0),t.setUint32(28,2*s,!0),t.setUint16(32,2,!0),t.setUint16(34,16,!0),a(t,36,"data"),t.setUint32(40,2*e,!0)}static writeWavData(t,e){for(let s=0,a=44;s<e.length;s++,a+=2){let i=Math.max(-1,Math.min(1,e[s]));t.setInt16(a,i<0?32768*i:32767*i,!0)}}}class F{constructor(t,e,s){this.audioCtx=t,this.url=e,this.data=s}async load(){return await fetch(this.url).then((t=>t.arrayBuffer())).then((t=>this.audioCtx.decodeAudioData(t))).then((t=>this.data.buffer=t)).catch(console.error)}}class Q{constructor(t,e){this.audioCtx=t,this.source=this.audioCtx.createMediaStreamSource(e),this.sp=this.audioCtx.createScriptProcessor(0,2,2),this.audioData=[],console.log("source: "+this.source.channelCount)}start(){this.source.connect(this.sp).connect(this.audioCtx.destination),this.sp.onaudioprocess=t=>this.audioData.push(R.AudioBuffer2WavData(t.inputBuffer)),this.onstart()}stop(){this.source.disconnect(),this.sp.disconnect(),this.onstop(R.writeWav(this.mergeBuffers(this.audioData),this.audioCtx.sampleRate)),this.audioData=[]}mergeBuffers(t){let e=0;for(let i=0;i<t.length;i++)e+=t[i].length;let s=new Float32Array(e),a=0;for(let i=0;i<t.length;i++)for(let e=0;e<t[i].length;e++)s[a]=t[i][e],a++;return s}}const N={name:"Count",props:["audioCtx"],data:()=>({isMuted:!1,number:1}),mounted(){this.bufferContainer={buffer:null},this.loader=new F(this.audioCtx,"/metronome.wav",this.bufferContainer),(async()=>{await this.loader.load()})()},computed:{rhythm(){return this.$store.state.rhythm},count_time(){return 60/this.$store.state.bpm*4/this.rhythm[1]}},methods:{start(t=0){setTimeout((()=>{0!==t?this.count():this.playMetronome(),this.countId=setInterval((()=>{this.count()}),1e3*this.count_time)}),1e3*t)},stop(){clearInterval(this.countId)},count(){this.number==this.rhythm[0]?this.number=1:this.number++,this.playMetronome()},playMetronome(){this.isMuted||(this.source=this.audioCtx.createBufferSource(),this.source.buffer=this.bufferContainer.buffer,this.source.connect(this.audioCtx.destination),this.source.start())},setNumberFromPointerX(t){const e=4*this.$store.state.beat_interval/this.rhythm[1];this.number=Math.ceil(t%(e*this.rhythm[0])/e),this.number<0&&(this.number+=this.rhythm[0])}}},M={id:"count"};N.render=function(a,i,n,r,c,l){return t(),e(o,null,[s("img",{id:"metronome",src:"/assets/metronome.7f7835d3.png",class:{white:!c.isMuted,red:c.isMuted},onClick:i[1]||(i[1]=t=>{c.isMuted=!c.isMuted})},null,2),s("div",M,h(c.number),1)],64)};const U={name:"InputElement",props:["length","default"],data(){return{isInputing:!1,value:this.default,disabled:!1}},methods:{finishInput(){this.value&&(this.isInputing=!1,this.$emit("value-changed",this.value))}}},O={class:"input"};U.render=function(s,i,n,o,d,u){return t(),e("div",O,[d.isInputing?a((t(),e("textarea",{key:1,rows:"1",cols:n.length,"onUpdate:modelValue":i[2]||(i[2]=t=>d.value=t),onKeydown:[i[3]||(i[3]=l(r(((...t)=>u.finishInput&&u.finishInput(...t)),["stop"]),["enter"])),i[4]||(i[4]=r((()=>{}),["stop"]))]},null,40,["cols"])),[[c,d.value]]):(t(),e("p",{key:0,onDblclick:i[1]||(i[1]=t=>{d.disabled||(d.isInputing=!0)})},h(d.value),33))])};const H={name:"Rhythm",components:{InputElement:U},methods:{valueChanged(t){this.$store.commit("rhythm",t.split("/").map((t=>Number(t))))}}};H.render=function(s,a,i,n,r,o){const h=d("InputElement");return t(),e(h,{length:"5",default:"4/4",onValueChanged:o.valueChanged},null,8,["onValueChanged"])};const V={name:"Bpm",components:{InputElement:U},computed:{disabled:{get:function(){return this.$refs.inputElement.disabled},set:function(t){this.$refs.inputElement.disabled=t}}},methods:{valueChanged(t){this.disabled?this.$refs.inputElement.value=this.$store.state.bpm:this.$store.commit("bpm",Number(t))}}};V.render=function(s,a,i,n,r,o){const h=d("InputElement");return t(),e(h,{length:"5",default:"120",onValueChanged:o.valueChanged,ref:"inputElement"},null,8,["onValueChanged"])};const $={name:"Resizer",data:()=>({value:20,disabled:!1}),methods:{valueChanged(){this.$store.commit("beat_interval",Number(this.value))}}};$.render=function(s,i,n,r,o,h){return a((t(),e("input",{type:"range",min:"10",max:"100",step:"1",title:o.value,"onUpdate:modelValue":i[1]||(i[1]=t=>o.value=t),onInput:i[2]||(i[2]=(...t)=>h.valueChanged&&h.valueChanged(...t)),disabled:o.disabled},null,40,["title","disabled"])),[[c,o.value]])};const L={name:"AddTrackBtn",emits:["add-track"]},z=s("img",{src:"/assets/plus_icon.d7fa19c0.png"},null,-1);L.render=function(s,a,i,n,r,o){return t(),e("div",{id:"add_track_btn",title:"トラックを追加",onClick:a[1]||(a[1]=t=>s.$emit("add-track"))},[z])};const _={name:"Ruler",mounted(){this.ctx=this.canvas.getContext("2d"),this.ctx.font="10px",this.draw()},computed:{rhythm(){return this.$store.state.rhythm},beat_interval(){return this.$store.state.beat_interval},number_of_bars(){return this.$store.state.number_of_bars},canvas(){return this.$refs.canvas}},watch:{rhythm(){this.draw()},beat_interval(){this.draw()},number_of_bars(){this.draw()}},methods:{draw(){const[t,e]=this.rhythm,s=4*this.beat_interval/e;this.canvas.width=s*t*this.number_of_bars,this.ctx.fillStyle="#323232",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.ctx.strokeStyle=this.ctx.fillStyle="#f0f0f0";for(let a=0;a<this.canvas.width/s;a++){let e=a*s;this.ctx.beginPath(),a%t==0?(this.ctx.fillText(`${Math.floor(a/t)}`,e,12),this.ctx.moveTo(e,15)):this.ctx.moveTo(e,25),this.ctx.lineTo(e,30),this.ctx.stroke()}}}},Y={id:"ruler",height:"30",ref:"canvas"};_.render=function(s,a,i,n,r,o){return t(),e("canvas",Y,null,512)};const J={name:"Pointer",data:()=>({styles:{top:"0px",left:"0px"}}),mounted(){this.ctx=this.canvas.getContext("2d"),this.canvas.height=window.innerHeight-80,this.ctx.fillStyle="#f0f0f0",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height)},computed:{beat_interval(){return this.$store.state.beat_interval},animation_width(){const t=this.$store.state;return t.bpm/60*this.beat_interval/t.animation_fps},canvas(){return this.$refs.canvas},x:{get:function(){return this.styles.left.slice(0,-2)-0},set:function(t){this.styles.left=t+"px"}},y:{get:function(){return this.styles.top.slice(0,-2)-0},set:function(t){this.styles.top=t+"px"}}},watch:{beat_interval(t,e){this.x*=t/e}},methods:{start(){let t=()=>{this.move(),this.animationId=requestAnimationFrame(t)};this.animationId=requestAnimationFrame(t)},stop(){cancelAnimationFrame(this.animationId)},prepareRecording(){const t=this.$store.state.rhythm,e=4*this.beat_interval/t[1];this.x=(Math.floor(this.x/e)-t[0])*e},move(){this.$emit("move",this.x),this.x+=this.animation_width}}};J.render=function(s,a,i,n,r,o){return t(),e("canvas",{id:"pointer",style:r.styles,width:"2",ref:"canvas"},null,4)};const G={name:"TrackSlider",props:["gainNode","pannerNode"],data:()=>({selectedValue:"V",gainValue:.5,panValue:0}),watch:{gainValue(t){this.gainNode.gain.value=t},panValue(t){this.pannerNode.pan.value=t}}},K=s("option",{selected:"",title:"Volume"},"V",-1),W=s("option",{title:"Pan"},"P",-1);G.render=function(n,r,o,h,l,d){return t(),e("div",null,[a(s("select",{"onUpdate:modelValue":r[1]||(r[1]=t=>l.selectedValue=t)},[K,W],512),[[u,l.selectedValue]]),a(s("input",{type:"range",min:"0",max:"1",step:"0.05","onUpdate:modelValue":r[2]||(r[2]=t=>l.gainValue=t),title:l.gainValue},null,8,["title"]),[[i,"V"===l.selectedValue],[c,l.gainValue]]),a(s("input",{type:"range",min:"-1",max:"1",step:"0.1","onUpdate:modelValue":r[3]||(r[3]=t=>l.panValue=t),title:l.panValue},null,8,["title"]),[[i,"P"===l.selectedValue],[c,l.panValue]])])};const X={name:"ContextMenu",data:()=>({styles:{top:"0px",left:"0px"},isShow:!1}),methods:{show(t){switch(t.type){case"contextmenu":t.preventDefault(),this.styles.top=t.clientY+"px",this.styles.left=t.clientX+"px";break;case"touchstart":if(2!==t.touches.length)return;this.styles.top=(t.touches[0].clientY+t.touches[1].clientY)/2+"px",this.styles.left=(t.touches[0].clientX+t.touches[1].clientX)/2+"px"}this.isShow=!0,setTimeout((()=>this.$refs.domElement.focus()))}}};X.render=function(r,o,h,c,l,d){return a((t(),e("div",{class:"context-menu",tabindex:"-1",style:l.styles,onBlur:o[1]||(o[1]=t=>{l.isShow=!1}),ref:"domElement"},[s("ul",null,[n(r.$slots,"default")])],36)),[[i,l.isShow]])};const Z={name:"TrackLabel",props:["gainNode","pannerNode"],emits:["track-selected","track-remove"],components:{InputElement:U,TrackSlider:G,ContextMenu:X},data:()=>({isSelected:!1})};Z.render=function(a,i,n,h,c,l){const u=d("InputElement"),f=d("TrackSlider"),m=d("ContextMenu");return t(),e(o,null,[s("div",{class:["track-label",{isTrackLabelSelected:c.isSelected}],onPointerdown:i[1]||(i[1]=t=>a.$emit("track-selected")),onContextmenu:i[2]||(i[2]=(...t)=>a.$refs.menu.show&&a.$refs.menu.show(...t)),onTouchstart:i[3]||(i[3]=(...t)=>a.$refs.menu.show&&a.$refs.menu.show(...t)),ref:"domElement"},[s("div",null,[s(u,{length:"10",default:"新規トラック",ref:"trackName"},null,512),s(f,{gainNode:n.gainNode,pannerNode:n.pannerNode,ref:"trackSlider"},null,8,["gainNode","pannerNode"])])],34),s(m,{ref:"menu"},{default:A((()=>[s("li",{onClick:i[4]||(i[4]=r((t=>a.$emit("track-remove")),["stop"]))},"削除")])),_:1},512)],64)};const q={name:"DraftCanvas",props:["audioCtx","stream"],data:()=>({styles:{left:"0px"},isShow:!1}),created(){this.analyser=this.audioCtx.createAnalyser(),this.audioCtx.createMediaStreamSource(this.stream).connect(this.analyser),this.analyser.fftSize=1024,this.dataArray=new Uint8Array(this.analyser.fftSize),this.drawPoint=0},mounted(){this.ctx=this.canvas.getContext("2d"),this.initCtxStyle()},computed:{animation_width(){const t=this.$store.state;return t.bpm/60*t.beat_interval/t.animation_fps},slice_width(){return this.animation_width/this.dataArray.length},canvas(){return this.$refs.canvas}},methods:{initCtxStyle(){this.ctx.fillStyle="#78328c",this.ctx.lineWidth=2,this.ctx.strokeStyle="#000"},show(t){this.styles.left=t+"px",this.canvas.width=1e3,this.initCtxStyle(),this.drawPoint=0,this.isShow=!0},hide(){this.isShow=!1},draw(){this.drawPoint>=this.canvas.width&&this.resize(),this.analyser.getByteTimeDomainData(this.dataArray),this.ctx.fillRect(this.drawPoint,0,this.animation_width,this.canvas.height),this.ctx.beginPath();for(let t=0;t<this.dataArray.length;t++){let e=this.dataArray[t]/256*this.canvas.height;0===t?this.ctx.moveTo(this.drawPoint,e):this.ctx.lineTo(this.drawPoint,e),this.drawPoint+=this.slice_width}this.ctx.stroke()},resize(){const t=document.createElement("canvas"),e=t.getContext("2d");t.width=this.canvas.width,t.height=this.canvas.height,e.drawImage(this.canvas,0,0,this.canvas.width,this.canvas.height),this.canvas.width+=1e3,this.initCtxStyle(),this.ctx.drawImage(t,0,0,t.width,t.height)}}};q.render=function(s,n,r,o,h,c){return a((t(),e("canvas",{class:"draft-canvas",style:h.styles,width:"1000",height:"120",ref:"canvas"},null,4)),[[i,h.isShow]])};class tt{constructor(t,e,s){this.audioCtx=t,this.audioNode=e,this.data=s}createSource(){this.source=this.audioCtx.createBufferSource(),this.source.buffer=this.data.buffer,this.source.connect(this.audioNode)}play(t,e,s){this.createSource(),this.source.onended=s,this.source.start(0,t,e-t)}pause(){this.source.stop()}}class et{constructor(t){this.audioCtx=t}getDrawData(t,e,s,a){const i=[];for(let n=0;n<t.numberOfChannels;n++)i[n]=this.getPeaks(this.getDrawRange(t.getChannelData(n),e,s),a);return i}getDrawRange(t,e,s){const a=this.audioCtx.sampleRate*e,i=this.audioCtx.sampleRate*s;return t.slice(Math.floor(a),Math.floor(i))}getPeaks(t,e){e||(e=4500);let s=Math.floor(t.length/e);s<1&&(s=1);const a=[];for(let i=0;i<t.length;i+=s){const e=this.getPeak(t,i,i+s);a.push(e.max,e.min)}return a}getPeak(t,e,s){const a=t.slice(e,s);let i=a[0],n=i;for(let r=0;r<a.length;r++){const t=a[r];t>i&&(i=t),t<n&&(n=t)}return Object.freeze({max:i,min:n})}}class st{constructor(t,e,s){this.canvas=t,this.ctx=e,this.data=s,this.initCtxStyle()}initCtxStyle(){this.ctx.fillStyle="#78328c",this.ctx.lineWidth=2,this.ctx.strokeStyle="#000"}draw(t){this.initCtxStyle(),this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),t.forEach((t=>this.drawData(t)))}drawData(t){const e=this.canvas.width/t.length;let s=0;this.ctx.beginPath();for(let a=0;a<t.length;a++){let i=(t[a]+1)/2*this.canvas.height;0===a?this.ctx.moveTo(s,i):this.ctx.lineTo(s,i),s+=e}this.ctx.stroke()}}const at={name:"AudioCanvas",components:{ContextMenu:X},props:["initConfig","audioCtx","audioNode"],emits:["track-selected","remove"],data:()=>({styles:{left:"0px"},width:0,isSelected:!1}),mounted(){this.ctx=this.canvas.getContext("2d"),this.x=this.initConfig.startPoint,this.diminished=this.initConfig.diminished||{left:0,right:0},this.canvas.ontouchmove=t=>{t.preventDefault(),t.stopPropagation()},this.canvas.onpointerdown=t=>{t.stopPropagation(),this.canvas.focus(),this.$emit("track-selected");const e=t.offsetX,s=this.canvas_width-e;this.canvas.onpointermove=e<=30||s<=30?this.resize.bind(this,e,s):this.move.bind(this,e)},this.canvas.ontouchend=t=>t.preventDefault(),this.canvas.onpointerup=this.canvas.onpointerout=t=>{t.preventDefault(),this.canvas.onpointermove=null},this.canvas.onclick=t=>t.preventDefault(),this.data={buffer:null},this.loader=new F(this.audioCtx,this.initConfig.url,this.data),this.player=new tt(this.audioCtx,this.audioNode,this.data),this.drawer=new st(this.canvas,this.ctx,this.data),this.drawdataprocessor=new et(this.audioCtx),(async()=>{if(await this.loader.load(),console.log(this.audioCtx.destination.channelCount),this.canvas_width=this.data.buffer.duration*this.second_width,this.canvas_width>this.ruler_width){const t=this.$store.state,e=Math.ceil(this.data.buffer.duration*t.bpm/60/t.rhythm[0]*4/t.rhythm[1]);this.$store.commit("number_of_bars",e)}})()},computed:{bpm(){return this.$store.state.bpm},beat_interval(){return this.$store.state.beat_interval},second_width(){return this.bpm/60*this.beat_interval},ruler_width(){const t=this.$store.state;return t.beat_interval*t.rhythm[0]*4/t.rhythm[1]*t.number_of_bars},canvas(){return this.$refs.canvas},x:{get:function(){return this.styles.left.slice(0,-2)-0},set:function(t){t<0&&(t=0),this.styles.left=t+"px"}},canvas_width:{get:function(){return this.width},set:function(t){this.width=Math.round(t)}},initStartPoint(){return this.x-this.diminished.left},initEndPoint(){return this.x+this.canvas_width+this.diminished.right},startPoint(){return this.x},endPoint(){return this.x+this.canvas_width}},watch:{bpm(t,e){this.canvas_width*=t/e},beat_interval(t,e){this.zoom(t,e)},canvas_width(){this.$nextTick((function(){this.draw()}))}},methods:{getTimeOfDistance(t){return 60/this.bpm*t/this.beat_interval},getTime(t){return 60/this.bpm*(t-this.initStartPoint)/this.beat_interval},play(t,e){this.player.play(this.getTime(t),this.getTime(this.endPoint),e)},pause(){this.player.pause()},draw(){this.drawer.draw(this.drawdataprocessor.getDrawData(this.data.buffer,this.getTime(this.startPoint),this.getTime(this.endPoint)))},async zoom(t,e){this.data.buffer||await this.loader.load();const s=t/e;this.diminished.left*=s,this.diminished.right*=s,this.x*=s,this.canvas_width*=s},move(t,e){this.x+=e.offsetX-t},resize(t,e,s){const a=s.offsetX,i=this.canvas_width-a,n=(t,e,s)=>{let a=Math.floor(e-t);-this.diminished[s]>a&&(a=-this.diminished[s]),"left"===s&&(this.x+=a),this.diminished[s]+=a,this.canvas_width-=a};t<=30?n(t,a,"left"):e<=30&&n(e,i,"right")},async getDownloadData(t,e){return await new Promise((s=>{const a=new XMLHttpRequest;a.open("GET",this.loader.url),a.responseType="blob",a.onload=()=>{t.file(e+".wav",a.response),s()},a.onerror=console.error,a.send()})),{startPoint:this.startPoint,diminished:this.diminished}},async getUploadData(){let t;return await new Promise((e=>{const s=new XMLHttpRequest;s.open("GET",this.loader.url),s.responseType="blob",s.onload=()=>{const a=new FileReader;a.onload=()=>{t=a.result,e()},a.readAsDataURL(s.response)},s.onerror=console.error,s.send()})),{startPoint:this.startPoint,diminished:this.diminished,base64:t}},createOfflineSource(t,e,s,a){const i=t.createBufferSource();i.buffer=this.data.buffer,i.connect(e);let n=this.getTimeOfDistance(this.startPoint)-s,r=this.getTimeOfDistance(this.diminished.left);n<=0&&(r<=-n&&(r=-n),n=0);let o=this.getTimeOfDistance(this.width)-r;const h=this.getTimeOfDistance(this.endPoint);h>=a&&(o-=h-a),i.start(n,r,o)}}};at.render=function(a,i,n,h,c,u){const f=d("ContextMenu");return t(),e(o,null,[s("canvas",{class:"audio-canvas",tabindex:"-1",style:c.styles,width:c.width,height:"120",onKeydown:i[1]||(i[1]=l(r((t=>a.$emit("remove")),["stop"]),["delete"])),onContextmenu:i[2]||(i[2]=(...t)=>a.$refs.menu.show&&a.$refs.menu.show(...t)),onTouchstart:i[3]||(i[3]=(...t)=>a.$refs.menu.show&&a.$refs.menu.show(...t)),ref:"canvas"},null,44,["width"]),s(f,{ref:"menu"},{default:A((()=>[s("li",{onClick:i[4]||(i[4]=r((t=>a.$emit("remove")),["stop"]))},"削除")])),_:1},512)],64)};const it={name:"TrackAudioContainer",components:{DraftCanvas:q,AudioCanvas:at},props:["audioCtx","audioNode","stream","pointer"],emits:["track-selected"],data:()=>({audioParamStack:[],lastAudioId:0,audioStack:[]}),created(){this.initRecorder()},methods:{setAudioRef(t){t&&!this.audioStack.includes(t)&&this.audioStack.push(t)},createAudioCanvas(t){this.audioStack=[],t.id=this.lastAudioId,this.audioParamStack.push(t),this.lastAudioId++},removeAudioCanvas(t){this.audioStack=[],this.audioParamStack.splice(t,1)},initRecorder(){let t,e;this.recorder=new Q(this.audioCtx,this.stream),this.recorder.onstart=()=>{t=this.pointer.x,this.$refs.draftCanvas.show(t);let s=()=>{this.$refs.draftCanvas.draw(),e=requestAnimationFrame(s)};e=requestAnimationFrame(s)},this.recorder.onstop=s=>{cancelAnimationFrame(e),this.createAudioCanvas({startPoint:t,url:s}),this.$refs.draftCanvas.hide()}},startRecording(){this.recorder.start()},stopRecording(){this.recorder.stop()},getCurrentAudio(t){return this.audioStack.find((e=>e&&e.startPoint<=t&&e.endPoint>=t))},play(){const t=()=>{var e;const s=this.pointer.x,a=this.getCurrentAudio(s);a&&a!==this.currentAudio&&(null==(e=this.currentAudio)||e.pause(),this.currentAudio=a,this.currentAudio.play(s,(()=>this.currentAudio=null))),this.playId=requestAnimationFrame(t)};this.playId=requestAnimationFrame(t)},pause(){var t;cancelAnimationFrame(this.playId),null==(t=this.currentAudio)||t.pause(),this.currentAudio=null},getDownloadData(t){return this.audioStack.map(((e,s)=>e.getDownloadData(t,s)))},getUploadData(){return this.audioStack.map((t=>t.getUploadData()))},createOffline(t,e,s,a){this.audioStack.forEach((i=>i.createOfflineSource(t,e,s,a)))}}};it.render=function(a,i,n,r,h,c){const l=d("DraftCanvas"),u=d("AudioCanvas");return t(),e("div",{class:"track_audio_container",onPointerdown:i[2]||(i[2]=t=>a.$emit("track-selected")),ref:"domElement"},[s(l,{audioCtx:n.audioCtx,stream:n.stream,ref:"draftCanvas"},null,8,["audioCtx","stream"]),(t(!0),e(o,null,f(h.audioParamStack,((s,r)=>(t(),e(u,{key:s.id,initConfig:s,audioCtx:n.audioCtx,audioNode:n.audioNode,ref:c.setAudioRef,onTrackSelected:i[1]||(i[1]=t=>a.$emit("track-selected")),onRemove:t=>c.removeAudioCanvas(r)},null,8,["initConfig","audioCtx","audioNode","onRemove"])))),128))],544)};const nt={name:"Track",components:{TrackLabel:Z,TrackAudioContainer:it},props:["data","audioCtx","stream","pointer"],emits:["track-remove"],data:()=>({gainNode:null,pannerNode:null}),created(){this.gainNode=this.audioCtx.createGain(),this.gainNode.gain.value=.5,this.pannerNode=this.audioCtx.createStereoPanner(),this.gainNode.connect(this.pannerNode).connect(this.audioCtx.destination)},mounted(){var t,e,s;this.name=(null==(e=this.data.name)?void 0:e.substring((null==(t=this.data)?void 0:t.name.indexOf("_"))+1))||"新規トラック",this.gain=this.data.gain||.5,this.pan=this.data.pan||0,null==(s=this.data.audioStack)||s.forEach((t=>this.$refs.container.createAudioCanvas(t)))},computed:{name:{get:function(){return this.$refs.label.$refs.trackName.value},set:function(t){this.$refs.label.$refs.trackName.value=t}},gain:{get:function(){return this.gainNode.gain.value},set:function(t){this.$refs.label.$refs.trackSlider.gainValue=t}},pan:{get:function(){return this.pannerNode.pan.value},set:function(t){this.$refs.label.$refs.trackSlider.panValue=t}},isSelected:{get:function(){return this.$refs.label.isSelected},set:function(t){this.$refs.label.isSelected=t}}},methods:{select(){this.$parent.tracks.forEach((t=>t.isSelected=!1)),this.isSelected=!0},startRecording(){this.$refs.container.startRecording()},stopRecording(){this.$refs.container.stopRecording()},play(){this.$refs.container.play()},pause(){this.$refs.container.pause()},async getDownloadData(t,e){const s=e+"_"+this.name;return{name:s,gain:this.gain,pan:this.pan,audioStack:await Promise.all(this.$refs.container.getDownloadData(t.folder(s)))}},async getUploadData(){return{name:this.name,gain:this.gain,pan:this.pan,audioStack:await Promise.all(this.$refs.container.getUploadData())}},createOffline(t,e,s){const a=t.createGain();a.gain.value=this.gain;const i=t.createStereoPanner();i.pan.value=this.pan,a.connect(i),i.connect(t.destination),this.$refs.container.createOffline(t,a,e,s)}}};nt.render=function(a,i,n,r,h,c){const l=d("TrackLabel"),u=d("TrackAudioContainer");return t(),e(o,null,[(t(),e(m,{to:"#label_field"},[s(l,{gainNode:h.gainNode,pannerNode:h.pannerNode,ref:"label",onTrackSelected:c.select,onTrackRemove:i[1]||(i[1]=t=>a.$emit("track-remove"))},null,8,["gainNode","pannerNode","onTrackSelected"])])),(t(),e(m,{to:"#audio_field"},[s(u,{audioCtx:n.audioCtx,audioNode:h.gainNode,stream:n.stream,pointer:n.pointer,ref:"container",onTrackSelected:c.select},null,8,["audioCtx","audioNode","stream","pointer","onTrackSelected"])]))],64)};const rt={name:"Editor",components:{Count:N,Rhythm:H,Bpm:V,Resizer:$,AddTrackBtn:L,Ruler:_,Pointer:J,Track:nt},data:()=>({trackParams:[],lastTrackId:0,tracks:[],audioCtx:null,stream:null,state:null}),created(){this.audioCtx=new(window.AudioContext||window.webkitAudioContext)},mounted(){window.onpopstate=t=>t.preventDefault(),window.onbeforeunload=t=>{t.preventDefault(),t.returnValue="ページを移動すると全てのデータが失われます。"};const t=this.$refs.label_field,e=this.$refs.audio_field;let s;t.onscroll=s=>e.scrollTop=t.scrollTop,e.onscroll=s=>{t.scrollTop=e.scrollTop,this.$refs.pointer.y=e.scrollTop},e.onclick=t=>{"recording"!==this.state&&(this.$refs.pointer.x=t.clientX-200+t.currentTarget.scrollLeft,this.$refs.count.setNumberFromPointerX(this.$refs.pointer.x))};const a=t=>{const e=t[0].clientX,s=t[0].clientY,a=t[1].clientX,i=t[1].clientY;return Math.sqrt(Math.pow(a-e,2),Math.pow(i-s))};e.ontouchstart=t=>{"recording"!==this.state&&2===t.touches.length&&(s=a(t.touches))},e.ontouchmove=t=>{if("recording"===this.state||2!==t.touches.length)return;t.preventDefault();const e=this.$store.state,i=a(t.touches),n=Math.round(e.beat_interval*i/s);n<10||n>100||(this.$refs.resizer.value=n,this.$store.commit("beat_interval",n),s=i)},e.ondragover=t=>{t.stopPropagation(),t.preventDefault()},e.ondrop=async t=>{var e,s;t.stopPropagation(),t.preventDefault();const a=t.dataTransfer.items;if(1===a.length){const t=a[0],i=(null==(e=t.getAsEntry)?void 0:e.call(t))||(null==(s=t.webkitGetAsEntry)?void 0:s.call(t));if(i.isFile)i.file((t=>{this.isAudioFile(t)&&this.loadAudioFile(t)}),console.error);else{const t={};await new Promise((e=>this.readProjectDirectory(i,t,e))),console.log(t),await this.loadProject(t.project)}}},this.setDefaultOnkeydown()},computed:{scale_interval(){const t=this.$store.state;return 4*t.beat_interval/t.rhythm[1]}},methods:{getTimeOfDistance(t){const e=this.$store.state;return 60/e.bpm*t/e.beat_interval},setTrackRef(t){t&&!this.tracks.includes(t)&&this.tracks.push(t)},async addTrack(t){switch(this.audioCtx.state){case"suspended":case"interrupted":this.audioCtx.resume()}(this.stream||(this.stream=await navigator.mediaDevices.getUserMedia({video:!1,audio:{autoGainControl:!1,channelCount:2,echoCancellation:!1,noiseSuppression:!1,sampleRate:44100}}).catch((t=>{console.error(t),window.alert("マイク入力を取得できません。")})),this.stream))&&(this.tracks=[],t||(t={}),t.id=this.lastTrackId,this.trackParams.push(t),this.lastTrackId++)},removeTrack(t){this.tracks=[],this.trackParams.splice(t,1)},removeSelectedTracks(){this.tracks.filter((t=>t.isSelected)).map((t=>this.trackParams.findIndex((e=>e.id===t.data.id)))).sort(((t,e)=>e-t)).forEach((t=>this.removeTrack(t)))},onPointerMove(t){const e=this.$refs.audio_field;"recording"===this.state&&t-e.scrollLeft>e.offsetWidth&&(e.scrollLeft+=e.offsetWidth),t>=this.$refs.ruler.$refs.canvas.width&&this.$store.commit("number_of_bars",this.$store.state.number_of_bars+30)},async startRecording(){this.selectedTracks=this.tracks.filter((t=>t.isSelected));const t=this.tracks.filter((t=>!t.isSelected));this.selectedTracks.length&&("playing"===this.state&&this.pause(),this.$refs.pointer.prepareRecording(),this.$refs.count.start(),this.$refs.pointer.start(),t.forEach((t=>t.play())),this.state="preparing",setTimeout((()=>{"preparing"===this.state&&(this.state="recording",this.$refs.bpm.disabled=!0,this.$refs.resizer.disabled=!0,this.selectedTracks.forEach((t=>t.startRecording())))}),1e3*this.getTimeOfDistance(this.scale_interval*this.$store.state.rhythm[0])))},stopRecording(){"recording"===this.state&&(this.$refs.bpm.disabled=!1,this.$refs.resizer.disabled=!1,this.selectedTracks.forEach((t=>t.stopRecording()))),this.pause()},play(){this.tracks.forEach((t=>t.play()));const t=this.getTimeOfDistance(this.scale_interval-this.$refs.pointer.x%this.scale_interval);this.$refs.count.start(t),this.$refs.pointer.start(),this.state="playing"},pause(){this.tracks.forEach((t=>t.pause())),this.$refs.count.stop(),this.$refs.pointer.stop(),this.state=null},setDefaultOnkeydown(){document.onkeydown=t=>{switch(t.key){case"r":"recording"!==this.state&&this.startRecording();break;case"Backspace":"recording"!==this.state&&this.removeSelectedTracks();break;case" ":switch(t.preventDefault(),this.state){case"preparing":case"recording":this.stopRecording();break;case"playing":this.pause();break;default:this.play()}}}},isAudioFile:t=>"audio"===t.type.split("/")[0],async loadAudioFile(t){const e=window.URL.createObjectURL(t);await this.addTrack({audioStack:[{startPoint:0,url:e}]})},download(t,e){const s=document.createElement("a");s.href=t,s.download=e,s.click()},async downloadProject(){const t=new p,e=t.folder("project");await this.createConfigBlob(e),t.generateAsync({type:"blob"}).then((t=>this.download(URL.createObjectURL(t),"project.zip")))},async createConfigBlob(t){const e=this.$store.state,s=JSON.stringify({rhythm:e.rhythm,bpm:e.bpm,beat_interval:e.beat_interval,number_of_bars:e.number_of_bars,tracks:await Promise.all(this.tracks.map(((e,s)=>e.getDownloadData(t,s))))});t.file("config.json",new Blob([s],{type:"application/json"}))},readProjectDirectory(t,e,s){t.isFile?t.file((t=>{if("config.json"===t.name){const a=new FileReader;a.onload=i=>{e[t.name]=JSON.parse(a.result),s()},a.readAsText(t)}else e[t.name]=window.URL.createObjectURL(t)}),console.error):t.isDirectory&&(e[t.name]={},t.createReader().readEntries((a=>a.forEach((a=>this.readProjectDirectory(a,e[t.name],s)))),console.error))},async loadProject(t){const e=t["config.json"];this.setConfig(e),await this.setTracksData(e.tracks,t)},setConfig(t){this.$store.commit("rhythm",t.rhythm.map((t=>Number(t)))),this.$store.commit("bpm",Number(t.bpm)),this.$store.commit("beat_interval",Number(t.beat_interval)),this.$store.commit("number_of_bars",Number(t.number_of_bars))},async setTracksData(t,e){for await(let s of t)s.audioStack.forEach(((t,a)=>{t.url=e[s.name][a+".wav"]})),await this.addTrack(s)},getStartAndStopTime(t){const e=t=>{const e=this.$store.state;return 4*(t.bar*e.rhythm[0]+t.beat-1)/e.rhythm[1]*60/e.bpm};return{start_time:e(t.start),stop_time:e(t.stop)}},writeProjectAudio(t){const{start_time:e,stop_time:s}=this.getStartAndStopTime(t),a=(s-e)*this.audioCtx.sampleRate,i=new(window.OfflineAudioContext||window.webkitOfflineAudioContext)(2,a,this.audioCtx.sampleRate);this.tracks.forEach((t=>t.createOffline(i,e,s))),i.startRendering().then((t=>this.download(R.AudioBuffer2WavFile(t),"project.wav"))).catch(console.error)},async getUploadData(){const t=this.$store.state;return{rhythm:t.rhythm,bpm:t.bpm,beat_interval:t.beat_interval,number_of_bars:t.number_of_bars,tracks:await Promise.all(this.tracks.map((t=>t.getUploadData())))}},async setSharedTracksData(t){for await(let e of t)e.audioStack.forEach((t=>{const e=atob(t.base64.split(",")[1]),s=t.base64.match(/(:)([a-z\/]+)(;)/)[2],a=new Uint8Array(e.length);for(let n=0;n<e.length;n++)a[n]=e.charCodeAt(n);const i=new Blob([a],{type:s});t.url=URL.createObjectURL(i)})),await this.addTrack(e)},async loadSharedProject(t){this.setConfig(t),await this.setSharedTracksData(t.tracks)}}},ot={id:"header"},ht={id:"label_field",ref:"label_field"},ct={id:"audio_field",ref:"audio_field"};rt.render=function(n,r,h,c,l,u){const A=d("Count"),m=d("Rhythm"),p=d("Bpm"),g=d("Resizer"),w=d("AddTrackBtn"),v=d("Pointer"),C=d("Ruler"),b=d("Track");return t(),e(o,null,[s("div",ot,[s(A,{ref:"count",audioCtx:l.audioCtx},null,8,["audioCtx"]),s(m,{ref:"rhythm"},null,512),a(s("img",{src:"data:image/png;base64,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",class:"play-or-pause",onClick:r[1]||(r[1]=(...t)=>u.play&&u.play(...t))},null,512),[[i,null===l.state]]),a(s("img",{src:"/assets/pause.002d3fec.png",class:"play-or-pause",onClick:r[2]||(r[2]=(...t)=>u.pause&&u.pause(...t))},null,512),[[i,"playing"===l.state]]),s("button",{type:"button",id:"start",onClick:r[3]||(r[3]=t=>"preparing"===l.state||"recording"===l.state?u.stopRecording():u.startRecording())},"R"),s(p,{ref:"bpm"},null,512),s(g,{ref:"resizer"},null,512)]),s("div",ht,[s(w,{onAddTrack:u.addTrack},null,8,["onAddTrack"])],512),s("div",ct,[s(v,{onMove:u.onPointerMove,ref:"pointer"},null,8,["onMove"]),s(C,{ref:"ruler"},null,512)],512),(t(!0),e(o,null,f(l.trackParams,((s,a)=>(t(),e(b,{key:s.id,data:s,audioCtx:l.audioCtx,stream:l.stream,pointer:n.$refs.pointer,ref:u.setTrackRef,onTrackRemove:t=>u.removeTrack(a)},null,8,["data","audioCtx","stream","pointer","onTrackRemove"])))),128))],64)};const lt={name:"App",components:{SideMenu:b,Popup:x,WriteRange:k,Editor:rt},data:()=>({isShowPopup:!1,popUpType:null,projectId:null,ajax:null}),methods:{shareProject(){this.projectId="loading",this.ajax=new WebSocket(`${"https:"===location.protocol?"wss":"ws"}://${location.host}/websocket`),this.ajax.onerror=t=>{this.projectId=null,console.error(t)},this.ajax.onopen=async()=>this.ajax.send(JSON.stringify({state:"shareProject",project:await this.$refs.editor.getUploadData()})),this.ajax.onmessage=t=>{const e=JSON.parse(t.data);switch(e.type){case"id":this.projectId=e.id,console.log("shareProject"+this.projectId);break;case"error":this.projectId=null,console.log(e.msg)}}},joinProject(){this.projectId="loading";const t=this.$refs.projectIdField.value;this.ajax=new WebSocket(`${"https:"===location.protocol?"wss":"ws"}://${location.host}/websocket`),this.ajax.onerror=t=>{this.projectId=null,console.error(t)},this.ajax.onopen=async()=>this.ajax.send(JSON.stringify({state:"joinProject",id:t})),this.ajax.onmessage=async e=>{const s=JSON.parse(e.data);switch(s.type){case"project":this.projectId=t,this.$refs.editor.loadSharedProject(s.project),console.log("joinProject "+this.projectId);break;case"error":this.projectId=null,console.log(s.msg)}}}}},dt=w("プロジェクトに参加:"),ut={key:1},At={key:2};lt.render=function(n,r,c,u,f,m){const p=d("SideMenu"),w=d("WriteRange"),v=d("Popup"),C=d("Editor");return t(),e(o,null,[s(p,null,{default:A((()=>[s("a",{onClick:r[1]||(r[1]=(...t)=>n.$refs.editor.downloadProject&&n.$refs.editor.downloadProject(...t))},"プロジェクトファイルをダウンロード"),s("a",{onClick:r[2]||(r[2]=t=>{f.isShowPopup=!0,f.popUpType="WriteRange"})},"選択範囲を書き出す"),null===f.projectId?(t(),e(o,{key:0},[s("a",{onClick:r[3]||(r[3]=(...t)=>m.shareProject&&m.shareProject(...t))},"プロジェクトを共有"),s("a",null,[dt,s("textarea",{cols:"2",rows:"1",style:{resize:"none","text-align":"right"},onKeydown:r[4]||(r[4]=l(((...t)=>m.joinProject&&m.joinProject(...t)),["enter"])),ref:"projectIdField"},null,544)])],64)):"loading"===f.projectId?(t(),e("a",ut,"Loading...")):(t(),e("a",At,"プロジェクトID: "+h(f.projectId),1))])),_:1}),a(s(v,null,{default:A((()=>["WriteRange"===f.popUpType?(t(),e(w,{key:0,onHidePopup:r[5]||(r[5]=t=>f.isShowPopup=!1),onWriteProject:n.$refs.editor.writeProjectAudio},null,8,["onWriteProject"])):g("",!0)])),_:1},512),[[i,f.isShowPopup]]),s(C,{ref:"editor"},null,512)],64)};const ft=v({state:()=>({rhythm:[4,4],bpm:120,beat_interval:20,number_of_bars:30,animation_fps:60}),mutations:{rhythm:(t,e)=>t.rhythm=e,bpm:(t,e)=>t.bpm=e,beat_interval:(t,e)=>t.beat_interval=e,number_of_bars:(t,e)=>t.number_of_bars=e}});C(lt).use(ft).mount("#app");
